<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="NodeJS, Sunny">
    <meta name="description" content="Node 核心Node 概述什么是 NodeNode 是一个 JS 的运行环境它比浏览器拥有更多的能力浏览器中的 JS
web api 提供了操作浏览器窗口和页面的能力BOM，DOM，AJAX这种能力是非常有限的跨域问题、文件读写Node ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>NodeJS | Sunny</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Sunny</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Sunny</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">NodeJS</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Front-end-article/">
                                <span class="chip bg-color">Front end article</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-26
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Node-核心"><a href="#Node-核心" class="headerlink" title="Node 核心"></a>Node 核心</h1><h2 id="Node-概述"><a href="#Node-概述" class="headerlink" title="Node 概述"></a>Node 概述</h2><h3 id="什么是-Node"><a href="#什么是-Node" class="headerlink" title="什么是 Node"></a>什么是 Node</h3><p>Node 是一个 JS 的运行环境<br>它比浏览器拥有更多的能力<br>浏览器中的 JS</p>
<p>web api 提供了操作浏览器窗口和页面的能力<br>BOM，DOM，AJAX<br>这种能力是非常有限的<br>跨域问题、文件读写<br>Node 中的 JS</p>
<p>Node Api 几乎提供了所有能做的事</p>
<p>浏览器提供了有限的能力，JS 只能使用浏览器提供的功能做有限的操作<br>Node 提供了完整的控制计算机的能力，NodeJS 几乎可以通过 Node 提供的接口，实现对整个操作系统的控制<br>为什么用 node？</p>
<ol>
<li>单线程，异步回调模式。没有线程之间的竞争。</li>
<li>IO 处理速度非常快。</li>
<li>不适合复杂运算。<blockquote>
<p>Node 的官网<a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a></p>
</blockquote>
</li>
</ol>
<blockquote>
<p>Node 民间中文网<a target="_blank" rel="noopener" href="http://nodejs.cn/">http://nodejs.cn/</a></p>
</blockquote>
<h3 id="我们通常用-Node-干什么？"><a href="#我们通常用-Node-干什么？" class="headerlink" title="我们通常用 Node 干什么？"></a>我们通常用 Node 干什么？</h3><ol>
<li>开发桌面应用程序</li>
<li>开发服务器应用程序</li>
</ol>
<p>Node 服务器不做任何与业务逻辑有关的事情。绝大部分时候，只是简单的转发请求。但可能会有一些额外的功能</p>
<ol>
<li>简单的信息记录：请求日志，用户偏好，广告信息</li>
<li>静态资源托管</li>
<li>缓存<blockquote>
<p>智能提示：npm init npm i -D @types/node</p>
</blockquote>
</li>
</ol>
<h2 id="全局对象-global"><a href="#全局对象-global" class="headerlink" title="全局对象 global"></a>全局对象 global</h2><blockquote>
<p>global 里面为何有属性 global。</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">setTimeout</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  console<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// obj本身咋办</span>
obj<span class="token punctuation">.</span>global <span class="token operator">=</span> obj<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 类似window:</span>
<span class="token comment">// window.window</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>setTimeout 返回结果是一个对象，windwo 里面返回一个数字<br>setInterval 返回结果是一个对象<br>setImmediate 类似于 setTimeout 0<br>console<br>**dirname 获取当前模块所在的目录（绝对地址），并非 global 属性<br>**filename 获取当前模块的文件路径，并非 global 属性</p>
<p>Buffer<br>类型化数组<br>继承自 UInt8Array（无符号）<br>计算机中存储的基本单位：字节<br>使用时、输出时可能需要用十六进制表示<a target="_blank" rel="noopener" href="http://blog.yuanjin.tech/article/94">http://blog.yuanjin.tech/article/94</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"aanina"</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;Buffer 61 61 6e 69 6e 61></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>process<br>cwd()<br>返回当前 nodejs 进程的工作目录</p>
<p>绝对路径<br>exit()<br>强制退出当前 node 进程<br>可传入退出码，0 表示成功退出，默认为 0<br>argv<br>String[]<br>获取命令中的所有参数</p>
<p>platform<br>获取当前的操作系统<br>支持 32 位+的操作系统<br>kill(pid)<br>根据进程 ID 杀死进程<br>env<br>获取环境变量对象</p>
<h2 id="Node-的模块化细节"><a href="#Node-的模块化细节" class="headerlink" title="Node 的模块化细节"></a>Node 的模块化细节</h2><h3 id="模块的查找"><a href="#模块的查找" class="headerlink" title="模块的查找"></a>模块的查找</h3><p>绝对路径<br>根据绝对路径直接加载模块<br>相对路径 ./ 或 ../<br>相对于当前模块<br>转换为绝对路径<br>加载模块<br>相对路径<br>首先检查是否是内置模块，如：fs、path 等<br>第二检查当前目录中的 node_modules<br>检查上级目录中的 node_modules<br>转换为绝对路径<br>加载模块<br>关于后缀名<br>如果不提供后缀名，自动补全<br>优先顺序：js、json、node、mjs<br>关于文件名<br>如果仅提供目录，不提供文件名，则自动寻找该目录中的 index.js<br>package.json 中的 main 字段<br>表示包的默认入口<br>导入或执行包时若仅提供目录，则使用 main 补全入口<br>默认值为 index.js</p>
<h3 id="module-对象"><a href="#module-对象" class="headerlink" title="module 对象"></a>module 对象</h3><pre><code>记录当前模块的信息
</code></pre>
<p>id:模块编号。绝对路径作为 id。如果是入口模块，id 就是一个点<br>path:哪里输出，就打印该文件路径<br>parent:那个模块正在用它</p>
<h3 id="require-函数"><a href="#require-函数" class="headerlink" title="require 函数"></a>require 函数</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"./index.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//会返回一个绝对路径</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>cache:已经缓存的对象<br>​</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 面试题
 */</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"当前模块路径： "</span><span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"当前模块文件： "</span><span class="token punctuation">,</span> __filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// 伪代码</span>
<span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 之前讲过，可复习</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>模拟 require 底层实现</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 伪代码</span>
<span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//1. 将modulePath转换为绝对路径：D:\repository\NodeJS\源码\myModule.js</span>
  <span class="token comment">//2. 判断是否该模块已有缓存</span>
  <span class="token comment">// if(require.cache["D:\\repository\\NodeJS\\源码\\myModule.js"])&#123;</span>
  <span class="token comment">//   return require.cache["D:\\repository\\NodeJS\\源码\\myModule.js"].result;</span>
  <span class="token comment">// &#125;</span>
  <span class="token comment">//3. 读取文件内容</span>
  <span class="token comment">//4. 包裹到一个函数中</span>
  <span class="token keyword">function</span> <span class="token function">__temp</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span>  __dirname<span class="token punctuation">,</span> __filename</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"当前模块路径："</span><span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"当前模块文件："</span><span class="token punctuation">,</span> __filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      b<span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//6. 创建module对象</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  <span class="token function">__temp</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">.</span>path<span class="token punctuation">,</span> module<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment">//最终返回结果</span>
<span class="token punctuation">&#125;</span>

require<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 一开始this===module.exports===exports</span>
随着改动，<span class="token keyword">this</span>始终等于exports<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="当执行一个模块或使用-require-时，会将模块放置在一个函数环境中"><a href="#当执行一个模块或使用-require-时，会将模块放置在一个函数环境中" class="headerlink" title="当执行一个模块或使用 require 时，会将模块放置在一个函数环境中"></a>当执行一个模块或使用 require 时，会将模块放置在一个函数环境中</h3><blockquote>
<p>面试：全局 this 指向谁？this 放在函数里面执行，一开始是 exports，改动后，this 就不一样了</p>
</blockquote>
<h2 id="扩展：Node-中的-ES-模块化"><a href="#扩展：Node-中的-ES-模块化" class="headerlink" title="扩展：Node 中的 ES 模块化"></a>扩展：Node 中的 ES 模块化</h2><p>目前，Node 中的 ES 模块化仍然处于试验阶段<br>模块要么是 commonjs，要么是 ES</p>
<ol>
<li>commonjs：默认情况下，都是 commonjs</li>
<li>ES：</li>
</ol>
<p>变成 ES 模块的两种方式：1. 文件后缀名为.mjs 2. 最近的 package.json 中 type 的值是 module<br>​</p>
<p>当使用 ES 模块化运行时，必须添加 –experimental-modules 标记</p>
<h2 id="基本内置模块"><a href="#基本内置模块" class="headerlink" title="基本内置模块"></a>基本内置模块</h2><h3 id="os"><a href="#os" class="headerlink" title="os"></a>os</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/os.html">https://nodejs.org/dist/latest-v12.x/docs/api/os.html</a></p>
</blockquote>
<p>EOL 一行结束的分隔符<br>arch()获取 cpu 的架构名<br>cpus()获取 cpu 的每一个核的信息<br>freeman()获取当前内存（字节）<br>homedir()获取用户目录<br>hostname()获取主机名<br>tmpdir()临时目录</p>
<h3 id="path-不会检查路径是否存在"><a href="#path-不会检查路径是否存在" class="headerlink" title="path 不会检查路径是否存在"></a>path 不会检查路径是否存在</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/path.html">https://nodejs.org/dist/latest-v12.x/docs/api/path.html</a></p>
</blockquote>
<p>basename 获取路径的最后一部分<br>sep 路径分隔符<br>delimiter 块分割<br>dirname 获取目录<br>extname 获取后缀名<br>join 路径拼接<br>normalize 规范化路径<br>relative 后面路径相对于前面路径<br>resolve 绝对路径，根路径</p>
<h3 id="url"><a href="#url" class="headerlink" title="url"></a>url</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/url.html">https://nodejs.org/dist/latest-v12.x/docs/api/url.html</a></p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">URL</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL<span class="token punctuation">.</span>URL</span><span class="token punctuation">(</span><span class="token string">"url路径"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 写法2：URL.parse("url路径")</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//有没有a属性</span>
url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//得到a属性</span>

如果<span class="token punctuation">;</span>
<span class="token comment">// const obj=&#123;&#125;转成字符串:URL.format(obj)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="util"><a href="#util" class="headerlink" title="util"></a>util</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/util.html">https://nodejs.org/dist/latest-v12.x/docs/api/util.html</a></p>
</blockquote>
<p>callbackify 异步函数转成 callback 形式</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"util"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 异步函数</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">1000</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 转同步函数</span>
<span class="token keyword">const</span> delayCallBack <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">callbackify</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">delayCallBack</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* delay(500).then(d => &#123;
    console.log(d);
&#125;) */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>inherits 继承。现在不用他了，用 class<br>isDeepStrictEqual 深度严格比较<br>promisify 回调转成异步函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"util"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">delayCallBack</span><span class="token punctuation">(</span><span class="token parameter">duration<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> delay <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>delayCallBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="文件-I-O"><a href="#文件-I-O" class="headerlink" title="文件 I/O"></a>文件 I/O</h2><h3 id="I-O：input-output"><a href="#I-O：input-output" class="headerlink" title="I/O：input output"></a>I/O：input output</h3><p>对外部设备的输入输出<br>外部设备<br>磁盘<br>网卡<br>显卡<br>打印机<br>其他…<br>IO 的速度往往低于内存和 CPU 的交互速度<br>​</p>
<blockquote>
<p>推荐书籍：现代操作系统</p>
</blockquote>
<p>​</p>
<h3 id="fs-模块"><a href="#fs-模块" class="headerlink" title="fs 模块"></a>fs 模块</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/fs.html">https://nodejs.org/dist/latest-v12.x/docs/api/fs.html</a></p>
</blockquote>
<p>读取一个文件 fs.readFile</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// fs.readFile("./")//相对路径相对于命令提示符，除了在require里面写上./是相对文件的，其他都是命令提示符</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 路径
 * 配置:可以是一个对象
 * 回调函数
 */</span>
<span class="token comment">/* fs.readFile(filename, "utf-8", (err, content) => &#123;
    console.log(content);//字节
    console.log(content.toString("utf-8"));//转成文字
&#125;); */</span>
<span class="token comment">// 这里，读取的内容为什么要放在回调函数？</span>
<span class="token comment">// 读文件需要时间，IO,IO的处理时间远大于内存CPU交互时间，同步会卡住</span>

<span class="token comment">// fs.readFileSync同步读取，会导致JS运行阻塞，及其影响性能。通常，在程序启动时运行优先有限的次数即可</span>

<span class="token comment">// promises</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>向文件写入内容 fs.writeFile</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果没有文件，则会新建文件，没有目录则报错</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 方法1：</span>
  <span class="token comment">// await fs.promises.writeFile(filename, 'abc');//覆盖 默认utf-8</span>
  <span class="token comment">// 要是不想覆盖，第三个参数&#123;flag:'a'&#125;//追加内容append</span>
  <span class="token comment">// 方法2：</span>
  <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"abcde"</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"写入成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>练习 : 复制文件 api : fs.copyFile</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> fromFilename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fromFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> toFilename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/1.copy.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>toFilename<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"copy success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取文件或目录信息 fs.stat<br>size: 占用字节<br>atime：上次访问时间<br>mtime：上次文件内容被修改时间<br>ctime：上次文件状态被修改时间<br>birthtime：文件创建时间<br>isDirectory()：判断是否是目录<br>isFile()：判断是否是文件</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const filename = path.resolve(__dirname, './myfiles');</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> stat <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//size属性：目录为size0，文件size有值</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"是否是目录"</span><span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"是否是文件"</span><span class="token punctuation">,</span> stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取目录中的文件和子目录 fs.readdir</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//得到（一级）子文件</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建目录 fs.mkdir</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"创建目录1成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>判断文件或目录是否存在 fs.exists<br>过时了，封装一个</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles/3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">"ENOENT"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 文件不存在</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exists</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"目录已存在，无需操作"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"目录创建成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>删除文件用 fs.unlink(‘路径’)</p>
<h3 id="练习：读取一个目录中的所有子目录和文件"><a href="#练习：读取一个目录中的所有子目录和文件" class="headerlink" title="练习：读取一个目录中的所有子目录和文件"></a>练习：读取一个目录中的所有子目录和文件</h3><p>每个目录或文件都是一个对象<br>属性<br>name：文件名<br>ext：后缀名，目录为空字符串<br>isFile：是否是一个文件<br>size：文件大小<br>createTime：日期对象，创建时间<br>updateTime：日期对象，修改时间<br>方法<br>getChildren()：得到目录的所有子文件对象，如果是文件，则返回空数组<br>getContent(isBuffer = false)：读取文件内容，如果是目录，则返回 null<br>​</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">File</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span> name<span class="token punctuation">,</span> ext<span class="token punctuation">,</span> isFile<span class="token punctuation">,</span> size<span class="token punctuation">,</span> createTime<span class="token punctuation">,</span> updateTime</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ext <span class="token operator">=</span> ext<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isFile <span class="token operator">=</span> isFile<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>createTime <span class="token operator">=</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updateTime <span class="token operator">=</span> updateTime<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter">isBuffer <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//文件（1.png）不可能有子文件</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拼接</span>
      <span class="token keyword">return</span> File<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> stat <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> isFile <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> size <span class="token operator">=</span> stat<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    <span class="token keyword">const</span> createTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>birthtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> updateTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>mtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> name<span class="token punctuation">,</span> ext<span class="token punctuation">,</span> isFile<span class="token punctuation">,</span> size<span class="token punctuation">,</span> createTime<span class="token punctuation">,</span> updateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readDir</span><span class="token punctuation">(</span><span class="token parameter">dirname</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">await</span> File<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> file<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./myfiles"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readDir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> datas <span class="token operator">=</span> <span class="token keyword">await</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="文件流"><a href="#文件流" class="headerlink" title="文件流"></a>文件流</h2><h3 id="什么是流"><a href="#什么是流" class="headerlink" title="什么是流"></a>什么是流</h3><p>流是指数据的流动，数据从一个地方缓缓的流动到另一个地方</p>
<p>流是有方向的<br>可读流: Readable<br>数据从源头流向内存<br>可写流: Writable<br>数据从内存流向源头<br>双工流：Duplex<br>数据即可从源头流向内存<br>又可从内存流向源头<br>为什么需要流</p>
<ol>
<li><p>其他介质和内存的数据规模不一致</p>
</li>
<li><p>其他介质和内存的数据处理能力不一致</p>
</li>
</ol>
<h3 id="文件流-1"><a href="#文件流-1" class="headerlink" title="文件流"></a>文件流</h3><p>什么是文件流：内存数据和磁盘文件数据之间的流动<br>文件流的创建</p>
<h4 id="fs-createReadStream-path-options"><a href="#fs-createReadStream-path-options" class="headerlink" title="fs.createReadStream(path[, options])"></a>fs.createReadStream(path[, options])</h4><p>含义：创建一个文件可读流，用于读取文件内容<br>path：读取的文件路径<br>options：可选配置<br>encoding：编码方式<br>start：起始字节<br>end：结束字节<br>highWaterMark：每次读取数量<br>如果 encoding 有值，该数量表示一个字符数<br>如果 encoding 为 null，该数量表示字节数<br>返回：Readable 的子类 ReadStream<br>事件：rs.on(事件名, 处理函数)<br>open<br>文件打开事件<br>文件被打开后触发<br>error<br>发生错误时触发<br>close<br>文件被关闭后触发<br>可通过 rs.close()手动关闭<br>或文件读取完成后自动关闭<br>autoClose 配置项默认为 true<br>data<br>读取到一部分数据后触发<br>注册 data 事件后，才会真正开始读取<br>每次读取 highWaterMark 指定的数量<br>回调函数中会附带读取到的数据<br>若指定了编码，则读取到的数据会自动按照编码转换为字符串<br>若没有指定编码，读取到的数据是 Buffer<br>end<br>所有数据读取完毕后触发<br>rs.pause()：暂停读取， 会触发 pause 事件<br>rs.resume()：恢复读取，会触发 resume 事件</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./abc.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  encoding<span class="token operator">:</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  autoClose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//读完后自动关闭，默认ture</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//怎么才算打开了呢，，，不明白</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"文件被打开"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"文件错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"文件关闭"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// let str = "";全部读完，拼接实现最后打印，这样就没必要用流了，直接用readfile就可了</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"读到了一部分数据"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// str += chunk;</span>
  rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//暂停</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"暂停了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"resume"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"恢复了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"全部数据读取完毕"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="fs-createWriteStream-path-options"><a href="#fs-createWriteStream-path-options" class="headerlink" title="fs.createWriteStream(path[, options])"></a>fs.createWriteStream(path[, options])</h4><p>创建一个写入流<br>path：写入的文件路径<br>options<br>flags：操作文件的方式<br>w：覆盖<br>a：追加<br>其他<br>encoding：编码方式<br>start：起始字节<br>highWaterMark：每次最多写入的字节数<br>返回：Writable 的字类 WriteStream</p>
<blockquote>
<p>ws.on(事件名, 处理函数)</p>
</blockquote>
<pre><code>    open
    error
    close
</code></pre>
<blockquote>
<p>ws.write(data)</p>
</blockquote>
<p>写入一组数据<br>data 可以是字符串或 Buffer<br>返回一个 boolean 值<br>true：写入通道没有被填满，接下来的数据可以直接写入，无须排队</p>
<p>false：写入通道目前已被填满，接下来的数据将进入写入队列</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"file/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  encoding<span class="token operator">:</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>

<span class="token keyword">const</span> flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"啊"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false 中文utf-8 三个字节</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>要特别注意背压问题，因为写入队列是内存中的数据，是有限的。内存里面积压了太多数据，磁盘处理不过来。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"file/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  encoding<span class="token operator">:</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//背压</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如何解决背压问题<br>利用返回的布尔值，true 就写，false 就等一会在写<br>当写入队列清空时，会触发 drain 事件<br>​</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"file/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  encoding<span class="token operator">:</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 一只写，直到到达上限，或无法在直接写入</span>
<span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"drain"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>ws.end([data])</p>
</blockquote>
<p>结束写入，将自动关闭文件</p>
<ol>
<li>是否自动关闭取决于 autoClose 配置</li>
<li>默认为 true</li>
</ol>
<p>data 是可选的，表示关闭前的最后一次写入</p>
<blockquote>
<p>需求：把文件读出来复制到 2.txt 里面</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 方式1</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> from <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./file/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> to <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./file/2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"方式1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">"方式1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"复制完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 方式2 流</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> from <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./file/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> to <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./file/2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"方式2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//读到一部分数据</span>
    <span class="token keyword">const</span> flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 表示下一次写入，会造成背压</span>
      rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"drain"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 可以继续写了</span>
    rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//恢复读取</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 写完了</span>
    ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭写入流</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">"方式2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"复制完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//时间和空间都少很多</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="rs-pipe-ws"><a href="#rs-pipe-ws" class="headerlink" title="rs.pipe(ws)"></a>rs.pipe(ws)</h4><p>将可读流连接到可写流<br>返回参数的值<br>该方法可解决背压问题</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 方法2简化</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> from <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./file/1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> to <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./file/2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">"方式2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//管道串起来</span>
  rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">"方式2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//时间和空间都少很多</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="net-模块"><a href="#net-模块" class="headerlink" title="net 模块"></a>net 模块</h2><h3 id="回顾-http-请求"><a href="#回顾-http-请求" class="headerlink" title="回顾 http 请求"></a>回顾 http 请求</h3><p>普通模式</p>
<p>长连接模式</p>
<h3 id="net-模块能干什么"><a href="#net-模块能干什么" class="headerlink" title="net 模块能干什么"></a>net 模块能干什么</h3><p>net 是一个通信模块，利用它，可以实现：进程间的通信 IPC（后端）；网络通信 TCP/IP（前端）<br>TCP/IP：给了数据，可以不回复，可以过段时间回复。<br>HTTP：请求完响应。一次请求，响应一次。</p>
<h3 id="创建客户端"><a href="#创建客户端" class="headerlink" title="创建客户端"></a>创建客户端</h3><p>net.createConnection(options[, connectListener])</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span>
    host<span class="token operator">:</span> <span class="token string">"duyi.ke.qq.com"</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回socket对象</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"来自服务器的消息"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//客户端没有向服务器发送任何请求，所以服务器没回应</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//所以要往流里面写入一些内容</span>
socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"你好"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//可以是字符串，可以是buffer   错误的HTTP格式</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​</p>
<p>返回：socket</p>
<p>socket 是一个特殊的文件<br>在 node 中表现为一个双工流对象<br>通过向流写入内容发送数据<br>通过监听流的内容获取数据</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span>
    host<span class="token operator">:</span> <span class="token string">"duyi.ke.qq.com"</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"来自服务器的消息"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//服务端挂断</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*  以下为http协议格式
socket.write(`请求行
请求头

请求体`);

怎么表示GET POST请求？？？GET POST是http搞出来的，不是TCP/IP的。GET在请求行里面 */</span>

socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET / HTTP/1.1
Host:duyi.ke.qq.com/
Connection:keep-alive

</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ``里面是HTTP,前面是TCP/IP</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"结束了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="创建服务器"><a href="#创建服务器" class="headerlink" title="创建服务器"></a>创建服务器</h3><p>net.createServer()<br>返回：server 对象</p>
<ol>
<li>server.listen(port)监听当前计算机中某个端口</li>
<li>server.on(“listening”, ()=&gt;{})开始监听端口后触发的事件</li>
<li>server.on(“connection”, socket=&gt;{})当某个连接到来时，触发该事件；事件的监听函数会获得一个 socket 对象</li>
</ol>
<h2 id="http-模块"><a href="#http-模块" class="headerlink" title="http 模块"></a>http 模块</h2><p>http 模块建立在 net 模块之上</p>
<ol>
<li>无须手动管理 socket</li>
<li>无须手动组装消息格式</li>
</ol>
<p>http.request(url[, options][, callback])</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/http.html#http_http_request_url_options_callback">https://nodejs.org/dist/latest-v12.x/docs/api/http.html#http_http_request_url_options_callback</a></p>
</blockquote>
<p>http.createServer([options][, requestlistener])</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v12.x/docs/api/http.html#http_http_createserver_options_requestlistener">https://nodejs.org/dist/latest-v12.x/docs/api/http.html#http_http_createserver_options_requestlistener</a></p>
</blockquote>
<p>总结<br>我是客户端<br>请求：ClientRequest 对象<br>响应：IncomingMessage 对象<br>我是服务器<br>请求：IncomingMessage 对象<br>响应：ServerResponse 对象<br>​</p>
<h2 id="https-协议"><a href="#https-协议" class="headerlink" title="https 协议"></a>https 协议</h2><h2 id="https-模块"><a href="#https-模块" class="headerlink" title="https 模块"></a>https 模块</h2><h3 id="服务器结构"><a href="#服务器结构" class="headerlink" title="服务器结构"></a>服务器结构</h3><h3 id="证书准备"><a href="#证书准备" class="headerlink" title="证书准备"></a>证书准备</h3><p>方式 1：网上购买权威机构证书 <a target="_blank" rel="noopener" href="https://www.aliyun.com/?utm_content=se_1000301881">https://www.aliyun.com/?utm_content=se_1000301881</a></p>
<ol>
<li>准备好 money</li>
<li>准备好服务器</li>
<li>准备好域名</li>
<li>该方式应用在部署环境中</li>
</ol>
<p>方案 2：本地产生证书<br>自己作为权威机构发布证书<br>具体方法<br>安装 openssl<br>下载源码，自行构建<a target="_blank" rel="noopener" href="https://github.com/openssl/openssl">https://github.com/openssl/openssl</a><br>下载 windows 安装包<a target="_blank" rel="noopener" href="https://slproweb.com/products/Win32OpenSSL.html">https://slproweb.com/products/Win32OpenSSL.html</a><br>mac 下自带<br>通过输入命令 openssl 测试<br>生成 CA 私钥<br>openssl genrsa -des3 -out ca-pri-key.pem 1024<br>genrsa：密钥对生成算法<br>-des3：使用对称加密算法 des3 对私钥进一步加密，命令运行过程中会让用户输入密码，该密码将作为 des3 算法的 key<br>-out ca-pri-key.pem：将加密后的私钥保存到当前目录的 ca-pri-key.pem 文件中<br>pem：Privacy-Enhanced Mail (PEM)<br>1024：私钥的字节数<br>生成 CA 公钥（证书请求）<br>openssl req -new -key ca-pri-key.pem -out ca-pub-key.pem<br>通过私钥文件 ca-pri-key.pem 中的内容，生成对应的公钥，保存到 ca-pub-key.pem 中<br>运行过程中要使用之前输入的密码来实现对私钥文件的解密<br>其他输入信息<br>Country Name：国家名 CN<br>Province Name：省份名 Sichuan<br>Local Name：城市名<br>Company Name：公司名<br>Unit Name：部门名<br>Common Name：站点名<br>…<br>生成 CA 证书<br>openssl x509 -req -in ca-pub-key.pem -signkey ca-pri-key.pem -out ca-cert.crt<br>使用 X.509 证书标准，通过证书请求文件 ca-pub-key.pem 生成证书，并使用私钥 ca-pri-key.pem 加密，然后把证书保存到 ca-cert.crt 文件中<br>​——华丽的分割线——-<br>生成服务器私钥<br>openssl genrsa -out server-key.pem 1024<br>生成服务器公钥<br>openssl req -new -key server-key.pem -out server-scr.pem<br>生成服务器证书<br>openssl x509 -req -CA ca-cert.crt -CAkey ca-pri-key.pem -CAcreateserial -in server-scr.pem -out server-cert.crt</p>
<h3 id="https-模块-1"><a href="#https-模块-1" class="headerlink" title="https 模块"></a>https 模块</h3><h2 id="node-生命周期"><a href="#node-生命周期" class="headerlink" title="node 生命周期"></a>node 生命周期</h2><p>timers：存放计时器的回调函数<br>poll：轮询队列<br>除了 timers、checks，绝大部分回调都会放入该队列<br>比如：文件的读取、监听用户请求<br>运作方式<br>如果 poll 中有回调，依次执行回调，直到清空队列<br>如果 poll 中没有回调 1. 等待其他队列中出现回调，结束该阶段，进入下一阶段 2. 如果其他队列也没有回调，持续等待，直到出现回调为止<br>check：检查阶段。使用 setImmediate 的回调会直接进入这个队列<br>事件循环中，每次打算执行一个回调之前，必须要先清空 nextTick 和 promise 队列</p>
<h2 id="EventEmitter"><a href="#EventEmitter" class="headerlink" title="EventEmitter"></a>EventEmitter</h2><p>node 事件管理的通用机制</p>
<p>内部维护多个事件队列<br>​</p>
<h1 id="MySql"><a href="#MySql" class="headerlink" title="MySql"></a>MySql</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/mysql/mysql-tutorial.html">https://www.runoob.com/mysql/mysql-tutorial.html</a></p>
</blockquote>
<h2 id="数据库简介"><a href="#数据库简介" class="headerlink" title="数据库简介"></a>数据库简介</h2><p>数据库的能干什么</p>
<ol>
<li>持久的存储数据：数据存储在硬盘文件中</li>
<li>备份和恢复数据</li>
<li>快速的存取数据</li>
<li>权限控制</li>
</ol>
<p>数据库的类型<br>关系数据库<br>特点<br>以表和表的关联构成的数据结构<br>优点<br>能表达复杂的数据关系<br>强大的查询语言，能精确查找想要的数据<br>缺点<br>读写性能比较差，尤其是海量数据的读写<br>数据结构比较死板<br>用途<br>存储结构复杂的数据<br>代表<br>Oracle<br>MySql<br>Sql Server<br>非关系型数据库<br>特点<br>以极其简单的结构存储数据<br>文档型<br>键值对<br>优点<br>格式灵活<br>海量数据读写效率很高<br>缺点<br>难以表示复杂的数据结构<br>对于复杂查询效率不好<br>用途<br>存储结构简单的数据<br>代表<br>MongoDB<br>Redis<br>Membase<br>面向对象数据库<br>略<br>术语<br>DB： database 数据库<br>DBA：database administrator 数据库管理员<br>DBMS：database management system 数据库管理系统<br>DBS：database system 数据库系统<br>DBS 包含 DB、DBA、DBMS<br>​</p>
<h2 id="MySql-的安装"><a href="#MySql-的安装" class="headerlink" title="MySql 的安装"></a>MySql 的安装</h2><p>MySql 特点<br>关系型数据库<br>瑞典 MySQL AB 已被 Oracle 收购<br>开源 轻量 快速<br>安装 MySql<br>官方下载源<a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a><br>腾讯下载源<a target="_blank" rel="noopener" href="https://pc.qq.com/detail/3/detail_1303.html">https://pc.qq.com/detail/3/detail_1303.html</a><br>安装流程：详细可以看视频<br>使用 命令都需要加分号<br>mysql -uroot -p：进入 mysql 命令交互<br>show variables like ‘character_set_%’;：查看当前数据库字符编码<br>修改 my.ini 文件中的默认字符编码 C:\ProgramData\MySQL\MySQL Server 8.0<br>net stop mysql80<br>net start mysql80<br>show databases;：查看当前拥有的数据库<br>exit 退出</p>
<p>界面操作数据库：navicat 工具 需要破解<br>mac 有网站<br>新建流程</p>
<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><p>SQL</p>
<ol>
<li><p> Structured Query Language 结构化查询语言</p>
</li>
<li><p> 大部分关系型数据，拥有着基本一致的 SQL 语法</p>
</li>
<li><p>分支</p>
<pre><code>     DDL
         Data Definition Language 数据定义语言
         操作数据库对象
             库
             表
             视图
             存储过程
     DML
         Data Manipulation Language 数据操控语言
         操作数据库中的记录
     DCL
         Data Control Language 数据控制语句
         操作用户权限
</code></pre>
<p> 管理库</p>
</li>
<li><p> 创建库</p>
</li>
</ol>
<p>方法 1：语句<br>找到查询，新建查询，写下代码：CREATE DATABASE abc;运行，刷新即可；<br>方法 2：图形化界面</p>
<ol start="2">
<li><p>切换当前库</p>
</li>
<li><p>删除库</p>
</li>
</ol>
<p>方法 1<br>图形化界面<br>方法 2<br>语句：drop database test;<br>管理表<br>创建表</p>
<p>每一列相当于一个字段<br>字段名<br>字段类型<br>bit：占 1 位，0 或 1，false 或 true<br>int：占 32 位，整数<br>decimal(M,N)：能精确计算的实数，M 是总的数字位数，N 是小数位数<br>char(n)：固定长度位 n 的字符<br>varchar(n)：长度可变，最大长度位 n 的字符<br>text：大量的字符<br>date：仅日期<br>datetime：日期和时间<br>time：仅时间<br>是不是 null<br>自增：自增的话必须作为主键</p>
<p>默认值<br>修改表：可以用界面（右键，设计表就可以修改），可以用语句，但是最终都是语句运行<br>​</p>
<pre><code>删除表：同理
</code></pre>
<p>​</p>
<p>主键和外键<br>主键（数字，字符串，uuid（全球唯一）都可以）<br>根据设计原则，每张表都要有主键<br>主键必须满足的要求<br>唯一<br>不能更改<br>无业务含义<br>外键<br>用于产生表关系的列<br>外键列会连接到另一张表（或自己）的主键<br>表关系<br>一对一<br>一个 A 对应一个 B，一个 B 对应一个 A<br>例如：用户和用户信息<br>把任意一张表的主键同时设置为外键</p>
<p>一对多<br>一个 A 对应多个 B，一个 B 对应一个 A，A 和 B 是一对多，B 和 A 是多对一<br>例如：班级和学生，用户和文章<br>在多一端的表上设置外键，对应到另一张表的主键<br>多对多<br>一个 A 对应多个 B，一个 B 对应多个 A<br>例如：学生和老师<br>需要新建一张关系表，关系表至少包含两个外键，分别对应到两张表<br>三大设计范式 1. 要求数据库表的每一列都是不可分割的原子数据项 2. 非主键列必须依赖于主键列 3. 非主键列必须直接依赖主键列<br>​</p>
<h2 id="表记录的增删改"><a href="#表记录的增删改" class="headerlink" title="表记录的增删改"></a>表记录的增删改</h2><p>DMLData Manipulation Language 数据操控语言<br>增 CREATE<br>查 Retrieve<br>改 UPDATE<br>删 DELETE<br>CRUD<br>​</p>
<p>增加语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 增加语句</span>
<span class="token comment">-- INSERT INTO `student`(stuno,`name`,birthday,sex,phone,classid)</span>
<span class="token comment">-- VALUES('500','成哥','1900-1-1',true, '1190223422',2);</span>

<span class="token comment">-- 性别默认值DEFAULT，不写的话自动是默认值</span>
<span class="token comment">-- INSERT INTO `student`(stuno,`name`,birthday,sex,phone,classid)</span>
<span class="token comment">-- VALUES('500','成哥','1900-1-1',DEFAULT, '1190223422',2);</span>
<span class="token comment">-- 增加多条</span>
<span class="token comment">-- INSERT INTO `student`(stuno,`name`,birthday,sex,phone,classid)</span>
<span class="token comment">-- VALUES('500','成哥','1900-1-1',DEFAULT, '1190223422',2),</span>
<span class="token comment">-- VALUES('500','邓哥','1900-2-1',DEFAULT, '1190223422',2);</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 修改语句</span>
<span class="token keyword">UPDATE</span> student <span class="token keyword">SET</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'邓旭明'</span>
<span class="token keyword">WHERE</span> ID<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>删除语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"> <span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> student
 <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'邓哥'</span><span class="token punctuation">;</span>
<span class="token comment">--  或者用id  WHERE id=11</span>
<span class="token comment">-- 删除只能删除行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="数据库的导出导入"><a href="#数据库的导出导入" class="headerlink" title="数据库的导出导入"></a>数据库的导出导入</h2><h2 id="单表基本查询"><a href="#单表基本查询" class="headerlink" title="单表基本查询"></a>单表基本查询</h2><p>select …from …<br>where …<br>order by …<br>limit …<br>select<br>别名 as *<br>case<br>distinct<br>from<br>where<br>=<br>in<br>is<br>is not &gt; &lt; &gt;= &lt;=<br>between<br>like<br>and<br>or<br>order by<br>asc<br>desc<br>limit<br>n,m 跳过 n 条数据，取出 m 条数据<br>注意运行顺序<br>from<br>where<br>select<br>order by<br>limit<br>​</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 从user表中找出id,loginid来</span>
<span class="token comment">-- SELECT id, loginid from `user`;</span>
<span class="token comment">-- SELECT ismale as '性别' from `employee`;也可以省略as</span>
<span class="token comment">-- SELECT ismale '性别' from `employee`;</span>

<span class="token comment">-- 匹配数据源里面的所有列</span>
<span class="token comment">-- SELECT * FROM `employee`;</span>
<span class="token comment">-- SELECT *, 'abc' as 'extra' from `employee`</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>case</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">写法<span class="token number">1</span>
<span class="token comment">-- SELECT id, `name`,ismale, salary from employee;</span>
<span class="token comment">-- 我想把ismale用男女表示 而不是0,1,并且把列名改成sex</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token keyword">case</span> ismale
<span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span>
<span class="token keyword">else</span> <span class="token string">'女'</span>
<span class="token keyword">end</span> sex<span class="token punctuation">,</span> salary <span class="token keyword">from</span> employee<span class="token punctuation">;</span>

写法<span class="token number">2</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token keyword">case</span>
<span class="token keyword">when</span> ismale <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span>
<span class="token keyword">else</span> <span class="token string">'女'</span>
<span class="token keyword">end</span> sex<span class="token punctuation">,</span>
salary
<span class="token keyword">FROM</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>工资分级别</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token keyword">case</span>
<span class="token keyword">when</span> ismale <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span>
<span class="token keyword">else</span> <span class="token string">'女'</span>
<span class="token keyword">end</span> sex<span class="token punctuation">,</span>
<span class="token keyword">case</span>
<span class="token keyword">when</span> salary<span class="token operator">>=</span><span class="token number">10000</span> <span class="token keyword">then</span> <span class="token string">'高'</span>
<span class="token keyword">when</span> salary<span class="token operator">>=</span><span class="token number">5000</span> <span class="token keyword">then</span> <span class="token string">'中'</span>
<span class="token keyword">else</span> <span class="token string">'低'</span>
<span class="token keyword">end</span> <span class="token punctuation">`</span><span class="token keyword">level</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
salary
<span class="token keyword">FROM</span> employee<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>where<br>​</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> employee
<span class="token keyword">WHERE</span> ismale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 注意运行顺序</span>
<span class="token comment">-- 先from</span>
<span class="token comment">-- 后where</span>
<span class="token comment">-- 后select</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 公司id在1和2中的部门</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> department
<span class="token keyword">WHERE</span> companyid <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token comment">-- 查询地址是null的</span>
<span class="token keyword">WHERE</span> LOCATION <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询地址不是null的</span>
<span class="token keyword">WHERE</span> LOCATION <span class="token operator">IS</span> <span class="token operator">not</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token comment">-- WHERE salary>=10000;</span>
<span class="token comment">-- WHERE salary BETWEEN 10000 and 12000;</span>
<span class="token comment">-- WHERE `name` LIKE '%袁%';  模糊匹配</span>
<span class="token comment">-- 性袁，长度为2</span>
<span class="token comment">-- WHERE `name` like '袁_';</span>


<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token keyword">WHERE</span> <span class="token punctuation">`</span>NAME<span class="token punctuation">`</span> <span class="token operator">like</span> <span class="token string">'张%'</span> <span class="token operator">and</span> ismale<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">and</span> salary <span class="token operator">>=</span> <span class="token number">12000</span>
<span class="token operator">or</span>
birthday <span class="token operator">>=</span> <span class="token string">'1996-1-1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>orderby</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token keyword">WHERE</span> <span class="token punctuation">`</span>NAME<span class="token punctuation">`</span> <span class="token operator">like</span> <span class="token string">'张%'</span> <span class="token operator">and</span> <span class="token punctuation">(</span>ismale<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">and</span> salary <span class="token operator">>=</span> <span class="token number">12000</span>
                            <span class="token operator">or</span>
                            birthday <span class="token operator">>=</span> <span class="token string">'1996-1-1'</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">desc</span><span class="token punctuation">;</span>
<span class="token comment">-- 工资排序desc asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">case</span> ismale
<span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span>
<span class="token keyword">else</span> <span class="token string">'女'</span>
<span class="token keyword">end</span> sex <span class="token keyword">from</span> employee
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sex <span class="token keyword">asc</span><span class="token punctuation">,</span> salary <span class="token keyword">desc</span><span class="token punctuation">;</span>
<span class="token comment">-- 性别升序排序，性别相同的那一部分进行薪资降序排序</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token keyword">LIMIT</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询user表，得到账号为admin，密码为123456的用户</span>
<span class="token comment">-- 登录</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>
<span class="token keyword">WHERE</span> loginid <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">and</span> loginpwd <span class="token operator">=</span> <span class="token string">'123123'</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询员工表，按照员工的入职时间降序排序，并且使用分页查询</span>
<span class="token comment">-- 查询第3页，每页5条数据</span>
<span class="token comment">-- limit (page-1)*pagesize, pagesize</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> employee<span class="token punctuation">.</span>joinDate <span class="token keyword">desc</span>
<span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span>

<span class="token comment">-- 查询工资最高的女员工</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee
<span class="token keyword">WHERE</span> ismale <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">desc</span>
<span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 所有员工分布的地址   去重DISTINCT</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> location <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="联表查询"><a href="#联表查询" class="headerlink" title="联表查询"></a>联表查询</h2><p>笛卡尔积，数量=两张表数量相乘</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">from</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span><span class="token punctuation">,</span> company<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>左连接，左外连接，left join<br>右连接，右外连接，right join</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 左连接：以左表为基准</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">from</span> department <span class="token keyword">as</span> d <span class="token keyword">left</span> <span class="token keyword">join</span> employee <span class="token keyword">as</span> e
<span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span>
<span class="token comment">-- 找不到的话 新生成一行,左表至少出现一次</span>

<span class="token comment">-- 右连接</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">from</span> employee <span class="token keyword">as</span> e <span class="token keyword">right</span> <span class="token keyword">join</span> department <span class="token keyword">as</span> d
<span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最常用：内连接，inner join</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> empname<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> dptname
<span class="token keyword">from</span> employee <span class="token keyword">as</span> e <span class="token keyword">inner</span> <span class="token keyword">join</span> department <span class="token keyword">as</span> d
<span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId<span class="token punctuation">;</span>


继续连接

<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> empname<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> dptname<span class="token punctuation">,</span>c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> companyname
<span class="token keyword">from</span> employee <span class="token keyword">as</span> e
<span class="token keyword">inner</span> <span class="token keyword">join</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">inner</span> <span class="token keyword">join</span> company c <span class="token keyword">on</span> d<span class="token punctuation">.</span>companyId <span class="token operator">=</span> c<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>练习</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 1. 创建一张team表，记录足球队</span>
<span class="token comment">-- 查询出对阵表</span>

<span class="token keyword">SELECT</span> t1<span class="token punctuation">.</span>name 主场<span class="token punctuation">,</span> t2<span class="token punctuation">.</span>name 客场
<span class="token keyword">FROM</span> team <span class="token keyword">as</span> t1<span class="token punctuation">,</span> team <span class="token keyword">as</span> t2
<span class="token keyword">WHERE</span> t1<span class="token punctuation">.</span>id <span class="token operator">!=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span class="token comment">//自己不能对阵自己</span>

<span class="token comment">-- 2. 显示出所有员工的姓名、性别（使用男或女显示）、入职时间、薪水、所属部门（显示部门名称）、所属公司（显示公司名称）</span>

<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 员工姓名<span class="token punctuation">,</span>
<span class="token keyword">case</span> ismale <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span> <span class="token keyword">else</span> <span class="token string">'女'</span> <span class="token keyword">end</span> 性别<span class="token punctuation">,</span>
e<span class="token punctuation">.</span>joinDate 入职时间<span class="token punctuation">,</span>
e<span class="token punctuation">.</span>salary 薪水<span class="token punctuation">,</span>
d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 部门名称<span class="token punctuation">,</span>
c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 公司名称
<span class="token keyword">FROM</span> employee e
<span class="token keyword">inner</span> <span class="token keyword">join</span> department d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">inner</span> <span class="token keyword">join</span> company c <span class="token keyword">on</span> d<span class="token punctuation">.</span>companyId <span class="token operator">=</span> c<span class="token punctuation">.</span>id

<span class="token comment">-- 3. 查询腾讯和蚂蚁金服的所有员工姓名、性别、入职时间、部门名、公司名</span>

<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 员工姓名<span class="token punctuation">,</span>
<span class="token keyword">case</span> ismale <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span> <span class="token keyword">else</span> <span class="token string">'女'</span> <span class="token keyword">end</span> 性别<span class="token punctuation">,</span>
e<span class="token punctuation">.</span>joinDate 入职时间<span class="token punctuation">,</span>
e<span class="token punctuation">.</span>salary 薪水<span class="token punctuation">,</span>
d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 部门名称<span class="token punctuation">,</span>
c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 公司名称
<span class="token keyword">FROM</span> employee e
<span class="token keyword">inner</span> <span class="token keyword">join</span> department d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">inner</span> <span class="token keyword">join</span> company c <span class="token keyword">on</span> d<span class="token punctuation">.</span>companyId <span class="token operator">=</span> c<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'腾讯科技'</span><span class="token punctuation">,</span> <span class="token string">'蚂蚁金服'</span><span class="token punctuation">)</span>

<span class="token comment">-- 4. 查询渡一教学部的所有员工姓名、性别、入职时间、部门名、公司名</span>

<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 员工姓名<span class="token punctuation">,</span>
<span class="token keyword">case</span> ismale <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'男'</span> <span class="token keyword">else</span> <span class="token string">'女'</span> <span class="token keyword">end</span> 性别<span class="token punctuation">,</span>
e<span class="token punctuation">.</span>joinDate 入职时间<span class="token punctuation">,</span>
e<span class="token punctuation">.</span>salary 薪水<span class="token punctuation">,</span>
d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 部门名称<span class="token punctuation">,</span>
c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> 公司名称
<span class="token keyword">FROM</span> employee e
<span class="token keyword">inner</span> <span class="token keyword">join</span> department d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptId <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">inner</span> <span class="token keyword">join</span> company c <span class="token keyword">on</span> d<span class="token punctuation">.</span>companyId <span class="token operator">=</span> c<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">like</span> <span class="token string">'%渡一%'</span> <span class="token operator">AND</span> d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'教学部'</span><span class="token punctuation">;</span>

<span class="token comment">-- 5. 列出所有公司员工居住的地址（要去掉重复）</span>

<span class="token keyword">select</span> <span class="token keyword">DISTINCT</span> location <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="函数和分组"><a href="#函数和分组" class="headerlink" title="函数和分组"></a>函数和分组</h2><p>函数<br>内置函数<br>数学<br>ABS(x) 返回 x 的绝对值<br>CEILING(x) 返回大于 x 的最小整数值<br>FLOOR(x) 返回小于 x 的最大整数值<br>MOD(x,y) 返回 x/y 的模（余数）<br>PI() 返回 pi 的值（圆周率）<br>RAND() 返回０到１内的随机值<br>ROUND(x,y) 返回参数 x 的四舍五入的有 y 位小数的值<br>TRUNCATE(x,y) 返回数字 x 截短为 y 位小数的结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> ABS<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> CEIL<span class="token punctuation">(</span><span class="token number">1.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token keyword">TRUNCATE</span><span class="token punctuation">(</span><span class="token number">3.1415926</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token keyword">TRUNCATE</span><span class="token punctuation">(</span>salary<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> employee<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre><code>    聚合
        AVG(col) 返回指定列的平均值
        COUNT(col) 返回指定列中非NULL值的个数
        MIN(col) 返回指定列的最小值
        MAX(col) 返回指定列的最大值
        SUM(col) 返回指定列的所有值之和
</code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>avg<span class="token punctuation">`</span><span class="token punctuation">,</span> id
<span class="token keyword">FROM</span> employee<span class="token punctuation">;</span>

<span class="token comment">-- 查询员工数量</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> employee<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> 员工数量<span class="token punctuation">,</span>
<span class="token function">avg</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> 平均薪资<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> 总薪资<span class="token punctuation">,</span>
<span class="token function">min</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> 最小薪资
<span class="token keyword">FROM</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre><code>    字符
        CONCAT(s1,s2...,sn) 将s1,s2...,sn连接成字符串
        CONCAT_WS(sep,s1,s2...,sn) 将s1,s2...,sn连接成字符串，并用sep字符间隔
        TRIM(str) 去除字符串首部和尾部的所有空格
        LTRIM(str) 从字符串str中切掉开头的空格
        RTRIM(str) 返回字符串str尾部的空格
    日期
        CURDATE()或CURRENT_DATE() 返回当前的日期
        CURTIME()或CURRENT_TIME() 返回当前的时间
        TIMESTAMPDIFF(part,  date1,date2) 返回date1到date2之间相隔的part值，part是用于指定的相隔的年或月或日等
            MICROSECOND
            SECOND
            MINUTE
            HOUR
            DAY
            WEEK
            MONTH
            QUARTER
            YEAR
</code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span>salary<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> employee<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> CURTIME<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span><span class="token string">'2010-1-1 11:11:11'</span><span class="token punctuation">,</span><span class="token string">'2010-1-2 11:11:12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> birthday<span class="token punctuation">,</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> age<span class="token comment">//计算年龄</span>
<span class="token keyword">from</span> employee
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>自定义函数<br>分组<br>运行顺序<br>from<br>join … on …<br>where<br>group by<br>select<br>having<br>order by<br>limit<br>分组后，只能查询分组的列和聚合列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询员工分布的居住地，以及每个居住地有多少名员工</span>
<span class="token comment">-- 天府三街 3</span>
<span class="token keyword">SELECT</span> location<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> empnumber<span class="token comment">//只能查询分组的列和聚合列</span>
<span class="token keyword">FROM</span> employee
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> location
<span class="token keyword">HAVING</span> empnumber<span class="token operator">>=</span><span class="token number">40</span>

<span class="token comment">-- 查询所有薪水在10000以上的员工的分布的居住地，然后仅得到聚集地大于30的结果</span>
<span class="token keyword">SELECT</span> location<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> empnumber
<span class="token keyword">FROM</span> employee
<span class="token keyword">WHERE</span> salary<span class="token operator">>=</span><span class="token number">10000</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> location
<span class="token keyword">HAVING</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>练习</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 1. 查询渡一每个部门的员工数量</span>

<span class="token keyword">SELECT</span> d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> number
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">like</span> <span class="token string">'%渡一%'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> d<span class="token punctuation">.</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 查询每个公司的员工数量</span>

<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> number
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span>

<span class="token comment">-- 3. 查询所有公司5年内入职的居住在万家湾的女员工数量</span>

<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> r<span class="token punctuation">.</span>number <span class="token operator">is</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">0</span> <span class="token keyword">ELSE</span> r<span class="token punctuation">.</span>number <span class="token keyword">END</span> <span class="token keyword">as</span> number
<span class="token keyword">FROM</span> company c <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> number
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">WHERE</span> TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span>joinDate<span class="token punctuation">,</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">5</span>
<span class="token operator">AND</span> e<span class="token punctuation">.</span>location <span class="token operator">like</span> <span class="token string">'%万家湾%'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">as</span> r <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> r<span class="token punctuation">.</span>id

<span class="token comment">-- 4. 查询渡一所有员工分布在哪些居住地，每个居住地的数量</span>

<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>location<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> empnumber
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%渡一%'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> e<span class="token punctuation">.</span>location

<span class="token comment">-- 5. 查询员工人数大于200的公司信息</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> company
<span class="token keyword">WHERE</span> id <span class="token operator">in</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>id
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span>
<span class="token keyword">HAVING</span> <span class="token function">count</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">200</span>
<span class="token punctuation">)</span>

<span class="token comment">-- 6. 查询渡一公司里比它平均工资高的员工</span>

<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%渡一%'</span> <span class="token operator">AND</span>
e<span class="token punctuation">.</span>salary<span class="token operator">></span><span class="token punctuation">(</span>
<span class="token comment">-- 查询渡一的平均薪资</span>
<span class="token keyword">SELECT</span> <span class="token function">avg</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>salary<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%渡一%'</span>
<span class="token punctuation">)</span>

<span class="token comment">-- 7. 查询渡一所有名字为两个字和三个字的员工对应人数</span>

<span class="token keyword">SELECT</span> CHAR_LENGTH<span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 姓名长度<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>E<span class="token punctuation">.</span>ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 员工数量
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%渡一%'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> CHAR_LENGTH<span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">HAVING</span> 姓名长度 <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment">-- 8. 查询每个公司每个月的总支出薪水，并按照从低到高排序</span>

<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> sumofsalary
<span class="token keyword">FROM</span> company <span class="token keyword">as</span> c <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> department <span class="token keyword">as</span> d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>companyId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> employee <span class="token keyword">as</span> e <span class="token keyword">on</span> d<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>deptId
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sumofsalary<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><blockquote>
<p>根据查询缓存出一个表格，根据表格查询</p>
</blockquote>
<p>操作视图属于 DDL（数据对象定义语言）<br>视图的表的数据在内存中，不在硬盘<br>视图建立方法：UI 界面（简单），然后可以直接写查询语句了，可以生成 SQL 预览<br>使用：直接 FROM 视图就行了，不用联表了<br>视图的作用：减少 sql 语句，从而减少网络传输</p>
<h1 id="数据驱动和-ORM"><a href="#数据驱动和-ORM" class="headerlink" title="数据驱动和 ORM"></a>数据驱动和 ORM</h1><h2 id="mysql-驱动程序"><a href="#mysql-驱动程序" class="headerlink" title="mysql 驱动程序"></a>mysql 驱动程序</h2><p>什么是驱动程序<br>驱动程序是连接内存和其他存储介质的桥梁<br>mysql 驱动程序是连接内存数据和 mysql 数据的桥梁<br>mysql 驱动程序通常使用<br>mysql 官方<br>mysql2 第三方（前身：mysql-native）<br>安装：npm i mysql2<br>mysql2 的使用<a target="_blank" rel="noopener" href="https://github.com/sidorares/node-mysql2#readme">https://github.com/sidorares/node-mysql2#readme</a></p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// get the client</span>
<span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mysql2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个数据库连接</span>
<span class="token keyword">const</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  host<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token comment">//主机</span>
  user<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token comment">//权限（账号）</span>
  password<span class="token operator">:</span> <span class="token string">"significance369"</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">"companydb"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// connection.end()//断开连接</span>

<span class="token comment">// 查询</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM `company`;"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// err:错误</span>
  <span class="token comment">// results:查询结果</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 增加</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
  <span class="token string">"insert into company(`name`, location, buildDate) values('abc', '阿萨德', curdate());"</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 修改</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
  <span class="token string">"update company set `name` = 'bcd' where id=4"</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 删除</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"delete from company where id=4"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用-Promise-来避免回调"><a href="#使用-Promise-来避免回调" class="headerlink" title="使用 Promise,来避免回调"></a>使用 Promise,来避免回调</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mysql2/promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    host<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token comment">//主机</span>
    user<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token comment">//权限（账号）</span>
    password<span class="token operator">:</span> <span class="token string">"significance369"</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> <span class="token string">"companydb"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 解构出result</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM `company`;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>防止 sql 注入<br>sql 注入：用户通过注入 sql 语句到最终查询中，导致了整个 sql 与预期行为不符<br>mysql 支持变量：变量的内容不作为任何 sql 关键字</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mysql2/promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 我想查询id等于某个值的员工</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    host<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token comment">//主机</span>
    user<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token comment">//权限（账号）</span>
    password<span class="token operator">:</span> <span class="token string">"significance369"</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> <span class="token string">"companydb"</span><span class="token punctuation">,</span>
    multipleStatements<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//可以运行多条sql语句</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 解构出result</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT * FROM employee where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 但是如果用户发送test(`''; delete from company where id=5`)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解决：mysql 支持变量：变量的内容不作为任何 sql 关键字（预编译 sql 语句）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from employee where id=?;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//数组里面依次指定问号位置是什么</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="连接池（详细见文档）"><a href="#连接池（详细见文档）" class="headerlink" title="连接池（详细见文档）"></a>连接池（详细见文档）</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mysql2/promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  host<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
  user<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">"significance369"</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">"companydb"</span><span class="token punctuation">,</span>
  multipleStatements<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from employee where id=?;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">''; delete from company where id=5</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>细节：处理模糊查询里面的问号（防止与 mysql 变量冲突）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mysql2/promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  host<span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
  user<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">"significance369"</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">"companydb"</span><span class="token punctuation">,</span>
  multipleStatements<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 模糊查询里面的？处理</span>
  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from employee where \`name\` like concat('%',?,'%');</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"袁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Sequelize-简介"><a href="#Sequelize-简介" class="headerlink" title="Sequelize 简介"></a>Sequelize 简介</h2><p><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN">https://github.com/demopark/sequelize-docs-Zh-CN</a></p>
<h3 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h3><p>Object Relational Mapping 对象关系映射<br>通过 ORM 框架，可以自动的把程序中的对象和数据库关联<br>ORM 框架会隐藏具体的数据库底层细节，让开 发者使用同样的数据操作接口，完成对不同数据库的操作</p>
<blockquote>
<p>见源码中的「ORM 原理图」</p>
</blockquote>
<p>ORM 的优势<br>开发者不用关心数据库，仅需关心对象<br>可轻易的完成数据库的移植<br>无须拼接复杂的 sql 语句即可完成精确查询</p>
<h3 id="Node-中的-ORM"><a href="#Node-中的-ORM" class="headerlink" title="Node 中的 ORM"></a>Node 中的 ORM</h3><p>Sequelize（就是一个 ORM 框架）<br>JS<br>TS<br>成熟<br>TypeORM<br>TS<br>不成熟</p>
<h2 id="模型定义和同步"><a href="#模型定义和同步" class="headerlink" title="模型定义和同步"></a>模型定义和同步</h2><p><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN">https://github.com/demopark/sequelize-docs-Zh-CN</a><br>​</p>
<p>npm i sequelize mysql2<br>​</p>
<p>案例：学校数据库<br>管理员<br>id<br>账号<br>密码<br>姓名<br>班级<br>id<br>名称<br>开班时间<br>学生<br>id<br>姓名<br>出生日期<br>性别<br>联系电话<br>所属班级<br>书籍<br>id<br>名称<br>图片<br>出版时间<br>作者<br>​</p>
<h2 id="模型的增删改"><a href="#模型的增删改" class="headerlink" title="模型的增删改"></a>模型的增删改</h2><p><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN">https://github.com/demopark/sequelize-docs-Zh-CN</a></p>
<h2 id="模拟数据"><a href="#模拟数据" class="headerlink" title="模拟数据"></a>模拟数据</h2><p><a target="_blank" rel="noopener" href="http://mockjs.com/">http://mockjs.com/</a></p>
<h2 id="数据抓取"><a href="#数据抓取" class="headerlink" title="数据抓取"></a>数据抓取</h2><p>抓取豆瓣读书中的书籍信息<br>涉及到的库<br>axios<br>发送一个 http 请求，得到服务器的响应结果<br>客户端和服务器通用<br>cheerio<br>Jquery 的核心库<br>与 dom 无关<br>​</p>
<h2 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h2><p><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN">https://github.com/demopark/sequelize-docs-Zh-CN</a><br>查询单个数据：findOne<br>按照主键查询单个数据：findByPK<br>查询多个数据：findAll<br>查询数量：count<br>包含关系：include<br>​</p>
<h2 id="MD5-加密"><a href="#MD5-加密" class="headerlink" title="MD5 加密"></a>MD5 加密</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/md5">https://www.npmjs.com/package/md5</a><br>npm i md5<br>md5 加密的特点<br>hash 加密算法的一种<br>可以将任何一个字符串，加密成一个固定长度的字符串<br>单向加密：只能加密无法解密<br>同样的源字符串加密后得到的结果固定</p>
<blockquote>
<p>兴趣可以研究一下手写 md5</p>
</blockquote>
<h2 id="moment"><a href="#moment" class="headerlink" title="moment"></a>moment</h2><p>官网<a target="_blank" rel="noopener" href="https://momentjs.com/">https://momentjs.com/</a><br>民间中文网<a target="_blank" rel="noopener" href="http://momentjs.cn/">http://momentjs.cn/</a><br>概念<br>utc 和北京时间<br>utc：世界协调时<br>以英国格林威治时间为标准<br>utc 时间和北京时间相差 8 小时<br>utc 的凌晨相当于北京时间的上午 8 点<br>时间戳 timestamp<br>某个 utc 时间到 utc1970-1-1 凌晨经过的毫秒数<br>也可以是秒数，用小数部分记录毫秒<br>注意点<br>时间戳表示的是 utc 时间的差异<br>对于服务器的影响<br>服务器可能会部署到世界的任何位置<br>服务器内部应该统一使用 utc 时间或时间戳，包括数据库<br>对于客户端的影响<br>客户端要给不同地区的客户友好的显示时间<br>客户端应该把时间戳或 utc 时间转换为本地时间显示<br>​</p>
<p>​</p>
<h2 id="数据验证"><a href="#数据验证" class="headerlink" title="数据验证"></a>数据验证</h2><p>数据验证的位置<br>前端（客户端）：为了用户体验，并不是为了安全<br>路由层：验证接口格式是否正常<br>业务逻辑层：保证业务完整性<br>数据库验证（约束）：保证数据完整性<br>相关库<br>validator <a target="_blank" rel="noopener" href="https://github.com/validatorjs/validator.js">https://github.com/validatorjs/validator.js</a><br>用于验证某个字符串是否满足某个规则<br>validate.js<a target="_blank" rel="noopener" href="http://validatejs.org/">http://validatejs.org/</a><br>用于验证某个对象的属性是否满足某些规则<br>​</p>
<h2 id="访问器和虚拟字段"><a href="#访问器和虚拟字段" class="headerlink" title="访问器和虚拟字段"></a>访问器和虚拟字段</h2><h2 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h2><p>log4js <a target="_blank" rel="noopener" href="https://log4js-node.github.io/log4js-node/">https://log4js-node.github.io/log4js-node/</a><br>概念<br>level：日志级别<br>例如调试日志、信息日志、错误日志等等<br>见源码中的示意图<br>category：日志分类<br>例如：sql 日志、请求日志等等<br>appender：日志出口<br>应该把日志写到哪？<br>日志的书写格式是什么（layouts）<br>​</p>
<h1 id="express"><a href="#express" class="headerlink" title="express"></a>express</h1><h2 id="express-的基本使用"><a href="#express-的基本使用" class="headerlink" title="express 的基本使用"></a>express 的基本使用</h2><pre><code>    官网[http://expressjs.com/](http://expressjs.com/)
    民间中文网[https://www.expressjs.com.cn/](https://www.expressjs.com.cn/)
</code></pre>
<h2 id="nodemon"><a href="#nodemon" class="headerlink" title="nodemon"></a>nodemon</h2><pre><code>    nodemon是一个监视器，用于监控工程中的文件变化，如果发现文件有变化，可以执行一段脚本
</code></pre>
<ol>
<li><p>npx nodemon index.js</p>
</li>
<li><p>配置</p>
</li>
<li><p>监控范围</p>
</li>
</ol>
<h2 id="express-中间件"><a href="#express-中间件" class="headerlink" title="express 中间件"></a>express 中间件</h2><p>配合 postman 调试</p>
<p>当匹配到了请求后<br>交给第一个处理函数处理<br>函数中需要手动的交给后续中间件处理<br>中间件处理的细节<br>如果后续已经没有了中间件<br>express 发现如果响应没有结束<br>express 会响应 404<br>如果中间件发生了错误<br>不会停止服务器<br>相当于调用了 next(错误对象)<br>寻找后续的错误处理中间件<br>如果没有，则响应 500</p>
<h2 id="常用中间件"><a href="#常用中间件" class="headerlink" title="常用中间件"></a>常用中间件</h2><pre><code>    express.static()
    express.json()
    express.urlencoded()
</code></pre>
<h2 id="express-路由"><a href="#express-路由" class="headerlink" title="express 路由"></a>express 路由</h2><h2 id="cookie-的基本概念"><a href="#cookie-的基本概念" class="headerlink" title="cookie 的基本概念"></a>cookie 的基本概念</h2><p>假设服务器有一个接口，通过请求这个接口，可以添加一个管理员<br>但是，不是任何人都有权力做这种操作的<br>那么服务器如何知道请求接口的人是有权力的呢？<br>答案是：只有登录过的管理员才能做这种操作<br>可问题是，客户端和服务器的传输使用的是 http 协议，http 协议是无状态的，什么叫无状态，就是<strong>服务器不知道这一次请求的人，跟之前登录请求成功的人是不是同一个人</strong></p>
<p>由于 http 协议的无状态，服务器<strong>忘记</strong>了之前的所有请求，它无法确定这一次请求的客户端，就是之前登录成功的那个客户端。<br>你可以把服务器想象成有着严重脸盲症的东哥，他没有办法分清楚跟他说话的人之前做过什么<br>于是，服务器想了一个办法<br>它按照下面的流程来认证客户端的身份</p>
<ol>
<li>客户端登录成功后，服务器会给客户端一个出入证（令牌 token）</li>
<li>后续客户端的每次请求，都必须要附带这个出入证（令牌 token）</li>
</ol>
<p>服务器发扬了认证不认人的优良传统，就可以很轻松的识别身份了。<br>但是，用户不可能只在一个网站登录，于是客户端会收到来自各个网站的出入证，因此，就要求客户端要有一个类似于卡包的东西，能够具备下面的功能：</p>
<ol>
<li><strong>能够存放多个出入证</strong>。这些出入证来自不同的网站，也可能是一个网站有多个出入证，分别用于出入不同的地方</li>
<li><strong>能够自动出示出入证</strong>。客户端在访问不同的网站时，能够自动的把对应的出入证附带请求发送出去。</li>
<li><strong>正确的出示出入证</strong>。客户端不能将肯德基的出入证发送给麦当劳。</li>
<li><strong>管理出入证的有效期</strong>。客户端要能够自动的发现那些已经过期的出入证，并把它从卡包内移除。</li>
</ol>
<p>能够满足上面所有要求的，就是 cookie<br>cookie 类似于一个卡包，专门用于存放各种出入证，并有着一套机制来自动管理这些证件。<br>卡包内的每一张卡片，称之为<strong>一个 cookie</strong>。</p>
<h1 id="cookie-的组成"><a href="#cookie-的组成" class="headerlink" title="cookie 的组成"></a>cookie 的组成</h1><p>cookie 是浏览器中特有的一个概念，它就像浏览器的专属卡包，管理着各个网站的身份信息。<br>每个 cookie 就相当于是属于某个网站的一个卡片，它记录了下面的信息：</p>
<ul>
<li>key：键，比如「身份编号」</li>
<li>value：值，比如袁小进的身份编号「14563D1550F2F76D69ECBF4DD54ABC95」，这有点像卡片的条形码，当然，它可以是任何信息</li>
<li>domain：域，表达这个 cookie 是属于哪个网站的，比如 yuanjin.tech，表示这个 cookie 是属于 yuanjin.tech 这个网站的</li>
<li>path：路径，表达这个 cookie 是属于该网站的哪个基路径的，就好比是同一家公司不同部门会颁发不同的出入证。比如/news，表示这个 cookie 属于/news 这个路径的。（后续详细解释）</li>
<li>secure：是否使用安全传输（后续详细解释）</li>
<li>expire：过期时间，表示该 cookie 在什么时候过期</li>
</ul>
<p>当浏览器向服务器发送一个请求的时候，它会瞄一眼自己的卡包，看看哪些卡片适合附带捎给服务器<br>如果一个 cookie<strong>同时满足</strong>以下条件，则这个 cookie 会被附带到请求中</p>
<ul>
<li>cookie 没有过期</li>
<li>cookie 中的域和这次请求的域是匹配的<ul>
<li>比如 cookie 中的域是 yuanjin.tech，则可以匹配的请求域是 yuanjin.tech、<a target="_blank" rel="noopener" href="http://www.yuanjin.tech、blogs.yuanjin.tech等等/">www.yuanjin.tech、blogs.yuanjin.tech等等</a></li>
<li>比如 cookie 中的域是<a target="_blank" rel="noopener" href="http://www.yuanjin.tech,则只能匹配www.yuanjin.tech这样的请求域/">www.yuanjin.tech，则只能匹配www.yuanjin.tech这样的请求域</a></li>
<li>cookie 是不在乎端口的，只要域匹配即可</li>
</ul>
</li>
<li>cookie 中的 path 和这次请求的 path 是匹配的<ul>
<li>比如 cookie 中的 path 是/news，则可以匹配的请求路径可以是/news、/news/detail、/news/a/b/c 等等，但不能匹配/blogs</li>
<li>如果 cookie 的 path 是/，可以想象，能够匹配所有的路径</li>
</ul>
</li>
<li>验证 cookie 的安全传输<ul>
<li>如果 cookie 的 secure 属性是 true，则请求协议必须是 https，否则不会发送该 cookie</li>
<li>如果 cookie 的 secure 属性是 false，则请求协议可以是 http，也可以是 https</li>
</ul>
</li>
</ul>
<p>如果一个 cookie 满足了上述的所有条件，则浏览器会把它自动加入到这次请求中<br>具体加入的方式是，<strong>浏览器会将符合条件的 cookie，自动放置到请求头中</strong>，例如，当我在浏览器中访问百度的时候，它在请求头中附带了下面的 cookie：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/758572/1631081045836-0422b945-1166-495f-8c41-177d669317a5.png#clientId=ue4c1b789-fef4-4&from=paste&id=udda2b2ee&margin=%5Bobject%20Object%5D&originHeight=918&originWidth=2360&originalType=url&ratio=1&status=done&style=none&taskId=ua1fd8359-5262-454f-a5fa-f135da55bfd"><br>看到打马赛克的地方了吗？这部分就是通过请求头 cookie 发送到服务器的，它的格式是键=值; 键=值; 键=值; …，每一个键值对就是一个符合条件的 cookie。<br><strong>cookie 中包含了重要的身份信息，永远不要把你的 cookie 泄露给别人！！！</strong>否则，他人就拿到了你的证件，有了证件，就具备了为所欲为的可能性。</p>
<h1 id="如何设置-cookie"><a href="#如何设置-cookie" class="headerlink" title="如何设置 cookie"></a>如何设置 cookie</h1><p>由于 cookie 是保存在浏览器端的，同时，很多证件又是服务器颁发的<br>所以，cookie 的设置有两种模式：</p>
<ul>
<li>服务器响应：这种模式是非常普遍的，当服务器决定给客户端颁发一个证件时，它会在响应的消息中包含 cookie，浏览器会自动的把 cookie 保存到卡包中</li>
<li>客户端自行设置：这种模式少见一些，不过也有可能会发生，比如用户关闭了某个广告，并选择了「以后不要再弹出」，此时就可以把这种小信息直接通过浏览器的 JS 代码保存到 cookie 中。后续请求服务器时，服务器会看到客户端不想要再次弹出广告的 cookie，于是就不会再发送广告过来了。</li>
</ul>
<h2 id="服务器端设置-cookie"><a href="#服务器端设置-cookie" class="headerlink" title="服务器端设置 cookie"></a>服务器端设置 cookie</h2><p>服务器可以通过设置响应头，来告诉浏览器应该如何设置 cookie<br>响应头按照下面的格式设置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">set-cookie</span><span class="token punctuation">:</span> cookie1
<span class="token key atrule">set-cookie</span><span class="token punctuation">:</span> cookie2
<span class="token key atrule">set-cookie</span><span class="token punctuation">:</span> cookie3
<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过这种模式，就可以在一次响应中设置多个 cookie 了，具体设置多少个 cookie，设置什么 cookie，根据你的需要自行处理<br>其中，每个 cookie 的格式如下：</p>
<pre class="line-numbers language-none"><code class="language-none">键&#x3D;值; path&#x3D;?; domain&#x3D;?; expire&#x3D;?; max-age&#x3D;?; secure; httponly<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>每个 cookie 除了键值对是必须要设置的，其他的属性都是可选的，并且顺序不限<br>当这样的响应头到达客户端后，<strong>浏览器会自动的将 cookie 保存到卡包中，如果卡包中已经存在一模一样的卡片（其他 key、path、domain 相同），则会自动的覆盖之前的设置</strong>。<br>下面，依次说明每个属性值：</p>
<ul>
<li><strong>path</strong>：设置 cookie 的路径。如果不设置，浏览器会将其自动设置为当前请求的路径。比如，浏览器请求的地址是/login，服务器响应了一个 set-cookie: a=1，浏览器会将该 cookie 的 path 设置为请求的路径/login</li>
<li><strong>domain</strong>：设置 cookie 的域。如果不设置，浏览器会自动将其设置为当前的请求域，比如，浏览器请求的地址是<a target="_blank" rel="noopener" href="http://www.yuanjin.tech,服务器响应了一个set-cookie/">http://www.yuanjin.tech，服务器响应了一个set-cookie</a>: a=1，浏览器会将该 cookie 的 domain 设置为请求的域<a target="_blank" rel="noopener" href="http://www.yuanjin.tech/">www.yuanjin.tech</a><ul>
<li>这里值得注意的是，如果服务器响应了一个无效的域，浏览器是不认的</li>
<li>什么是无效的域？就是响应的域连根域都不一样。比如，浏览器请求的域是 yuanjin.tech，服务器响应的 cookie 是 set-cookie: a=1; domain=baidu.com，这样的域浏览器是不认的。</li>
<li>如果浏览器连这样的情况都允许，就意味着张三的服务器，有权利给用户一个 cookie，用于访问李四的服务器，这会造成很多安全性的问题</li>
</ul>
</li>
<li><strong>expire</strong>：设置 cookie 的过期时间。这里必须是一个有效的 GMT 时间，即格林威治标准时间字符串，比如 Fri, 17 Apr 2020 09:35:59 GMT，表示格林威治时间的 2020-04-17 09:35:59，即北京时间的 2020-04-17 17:35:59。当客户端的时间达到这个时间点后，会自动销毁该 cookie。</li>
<li><strong>max-age</strong>：设置 cookie 的相对有效期。expire 和 max-age 通常仅设置一个即可。比如设置 max-age 为 1000，浏览器在添加 cookie 时，会自动设置它的 expire 为当前时间加上 1000 秒，作为过期时间。<ul>
<li>如果不设置 expire，又没有设置 max-age，则表示会话结束后过期。</li>
<li>对于大部分浏览器而言，关闭所有浏览器窗口意味着会话结束。</li>
</ul>
</li>
<li><strong>secure</strong>：设置 cookie 是否是安全连接。如果设置了该值，则表示该 cookie 后续只能随着 https 请求发送。如果不设置，则表示该 cookie 会随着所有请求发送。</li>
<li><strong>httponly</strong>：设置 cookie 是否仅能用于传输。如果设置了该值，表示该 cookie 仅能用于传输，而不允许在客户端通过 JS 获取，这对防止跨站脚本攻击（XSS）会很有用。<ul>
<li>关于如何通过 JS 获取，后续会讲解</li>
<li>关于什么是 XSS，不在本文讨论范围</li>
</ul>
</li>
</ul>
<p>下面来一个例子，客户端通过 post 请求服务器<a target="_blank" rel="noopener" href="http://yuanjin.tech/login%EF%BC%8C%E5%B9%B6%E5%9C%A8%E6%B6%88%E6%81%AF%E4%BD%93%E4%B8%AD%E7%BB%99%E4%BA%88%E4%BA%86%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E5%9C%A8%E5%93%8D%E5%BA%94%E5%A4%B4%E4%B8%AD%E5%8A%A0%E5%85%A5%E4%BA%86%E4%BB%A5%E4%B8%8B%E5%86%85%E5%AE%B9%EF%BC%9A">http://yuanjin.tech/login，并在消息体中给予了账号和密码，服务器验证登录成功后，在响应头中加入了以下内容：</a></p>
<pre class="line-numbers language-none"><code class="language-none">set-cookie: token&#x3D;123456; path&#x3D;&#x2F;; max-age&#x3D;3600; httponly<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当该响应到达浏览器后，浏览器会创建下面的 cookie：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">key</span><span class="token punctuation">:</span> token
<span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">123456</span>
<span class="token key atrule">domain</span><span class="token punctuation">:</span> yuanjin.tech
<span class="token key atrule">path</span><span class="token punctuation">:</span> /
<span class="token key atrule">expire</span><span class="token punctuation">:</span> <span class="token datetime number">2020-04-17 18:55:00</span> <span class="token comment">#假设当前时间是2020-04-17 17:55:00</span>
<span class="token key atrule">secure</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#任何请求都可以附带这个cookie，只要满足其他要求</span>
<span class="token key atrule">httponly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#不允许JS获取该cookie</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是，随着浏览器后续对服务器的请求，只要满足要求，这个 cookie 就会被附带到请求头中传给服务器：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cookie</span><span class="token punctuation">:</span> token=123456; 其他cookie<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>现在，还剩下最后一个问题，就是如何删除浏览器的一个 cookie 呢？<br>如果要删除浏览器的 cookie，只需要让服务器响应一个同样的域、同样的路径、同样的 key，只是时间过期的 cookie 即可<br><strong>所以，删除 cookie 其实就是修改 cookie</strong><br>下面的响应会让浏览器删除 token</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cookie</span><span class="token punctuation">:</span> token=; domain=yuanjin.tech; path=/; max<span class="token punctuation">-</span>age=<span class="token punctuation">-</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>浏览器按照要求修改了 cookie 后，会发现 cookie 已经过期，于是自然就会删除了。<br>无论是修改还是删除，都要注意 cookie 的域和路径，因为完全可能存在域或路径不同，但 key 相同的 cookie<br>因此无法仅通过 key 确定是哪一个 cookie</p>
<h2 id="客户端设置-cookie"><a href="#客户端设置-cookie" class="headerlink" title="客户端设置 cookie"></a>客户端设置 cookie</h2><p>既然 cookie 是存放在浏览器端的，所以浏览器向 JS 公开了接口，让其可以设置 cookie</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">document.cookie = "键=值; path=<span class="token punctuation">?</span>; domain=<span class="token punctuation">?</span>; expire=<span class="token punctuation">?</span>; max<span class="token punctuation">-</span>age=<span class="token punctuation">?</span>; secure";<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看出，在客户端设置 cookie，和服务器设置 cookie 的格式一样，只是有下面的不同</p>
<ul>
<li>没有 httponly。因为 httponly 本来就是为了限制在客户端访问的，既然你是在客户端配置，自然失去了限制的意义。</li>
<li>path 的默认值。在服务器端设置 cookie 时，如果没有写 path，使用的是请求的 path。而在客户端设置 cookie 时，也许根本没有请求发生。因此，path 在客户端设置时的默认值是当前网页的 path</li>
<li>domain 的默认值。和 path 同理，客户端设置时的默认值是当前网页的 domain</li>
<li>其他：一样</li>
<li>删除 cookie：和服务器也一样，修改 cookie 的过期时间即可</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上，就是 cookie 原理部分的内容。<br>如果把它用于登录场景，就是如下的流程：<br><strong>登录请求</strong></p>
<ol>
<li>浏览器发送请求到服务器，附带账号密码</li>
<li>服务器验证账号密码是否正确，如果不正确，响应错误，如果正确，在响应头中设置 cookie，附带登录认证信息（至于登录认证信息是设么样的，如何设计，要考虑哪些问题，就是另一个话题了，可以百度 jwt）</li>
<li>客户端收到 cookie，浏览器自动记录下来</li>
</ol>
<p><strong>后续请求</strong></p>
<ol>
<li>浏览器发送请求到服务器，希望添加一个管理员，并将 cookie 自动附带到请求中</li>
<li>服务器先获取 cookie，验证 cookie 中的信息是否正确，如果不正确，不予以操作，如果正确，完成正常的业务流程</li>
</ol>
<h2 id="实现登录和认证"><a href="#实现登录和认证" class="headerlink" title="实现登录和认证"></a>实现登录和认证</h2><pre><code>    使用 cookie-parser  [https://github.com/expressjs/cookie-parser#readme](https://github.com/expressjs/cookie-parser#readme)
    登录成功后给予token
        通过cookie给予：适配浏览器
        通过header给予：适配其他终端
    对后续请求进行认证
        解析cookie或header中的token
        验证token
            通过：继续后续处理
            未通过：给予错误
</code></pre>
<h2 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h2><pre><code>    node --inspect 启动模块
        node进程会监听9229端口
</code></pre>
<h2 id="跨域之-JSONP"><a href="#跨域之-JSONP" class="headerlink" title="跨域之 JSONP"></a>跨域之 JSONP</h2><pre><code>    同源策略
        同源
            协议
            端口
            主机名
            完全相同
        浏览器不允许使用非同源的数据
    解决方案
        JSONP
        CORS
    JSONP
        1. 浏览器端生成一个script元素，访问数据接口
        2. 服务器响应一段JS代码，调用某个函数，并把响应的数据传入
    JSONP的缺陷
        会严重影响服务器的正常响应格式
        只能使用GET请求
</code></pre>
<h2 id="跨域之-CORS"><a href="#跨域之-CORS" class="headerlink" title="跨域之 CORS"></a>跨域之 CORS</h2><blockquote>
<p>阅读本文，你需要首先知道：</p>
<ol>
<li>浏览器的同源策略</li>
<li>跨域问题</li>
<li>JSONP 原理</li>
<li>cookie 原理</li>
</ol>
</blockquote>
<p>JSONP 并不是一个好的跨域解决方案，它至少有着下面两个严重问题：</p>
<ol>
<li><strong>会打乱服务器的消息格式</strong>：JSONP 要求服务器响应一段 JS 代码，但在非跨域的情况下，服务器又需要响应一个正常的 JSON 格式</li>
<li><strong>只能完成 GET 请求</strong>：JSONP 的原理会要求浏览器端生成一个<code>script</code>元素，而<code>script</code>元素发出的请求只能是<code>get</code>请求</li>
</ol>
<p>所以，CORS 是一种更好的跨域解决方案。</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><code>CORS</code>是基于<code>http1.1</code>的一种跨域解决方案，它的全称是<strong>C</strong>ross-<strong>O</strong>rigin <strong>R</strong>esource <strong>S</strong>haring，跨域资源共享。</p>
<p>它的总体思路是：<strong>如果浏览器要跨域访问服务器的资源，需要获得服务器的允许</strong></p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200421152122793.png#id=oi0LH&originHeight=380&originWidth=732&originalType=binary&ratio=1&status=done&style=none"></p>
<p>而要知道，一个请求可以附带很多信息，从而会对服务器造成不同程度的影响</p>
<p>比如有的请求只是获取一些新闻，有的请求会改动服务器的数据</p>
<p>针对不同的请求，CORS 规定了三种不同的交互模式，分别是：</p>
<ul>
<li><strong>简单请求</strong></li>
<li><strong>需要预检的请求</strong></li>
<li><strong>附带身份凭证的请求</strong></li>
</ul>
<p>这三种模式从上到下层层递进，请求可以做的事越来越多，要求也越来越严格。</p>
<p>下面分别说明三种请求模式的具体规范。</p>
<h1 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h1><p>当浏览器端运行了一段 ajax 代码（无论是使用 XMLHttpRequest 还是 fetch api），浏览器会首先判断它属于哪一种请求模式</p>
<h2 id="简单请求的判定"><a href="#简单请求的判定" class="headerlink" title="简单请求的判定"></a>简单请求的判定</h2><p>当请求<strong>同时满足</strong>以下条件时，浏览器会认为它是一个简单请求：</p>
<ol>
<li> <strong>请求方法属于下面的一种：</strong></li>
</ol>
<ul>
<li>get</li>
<li>post</li>
<li>head</li>
</ul>
<ol start="2">
<li> <strong>请求头仅包含安全的字段，常见的安全字段如下：</strong></li>
</ol>
<ul>
<li><code>Accept</code></li>
<li><code>Accept-Language</code></li>
<li><code>Content-Language</code></li>
<li><code>Content-Type</code></li>
<li><code>DPR</code></li>
<li><code>Downlink</code></li>
<li><code>Save-Data</code></li>
<li><code>Viewport-Width</code></li>
<li><code>Width</code></li>
</ul>
<ol start="3">
<li> <strong>请求头如果包含</strong><code>**Content-Type**</code><strong>，仅限下面的值之一：</strong></li>
</ol>
<ul>
<li><code>text/plain</code></li>
<li><code>multipart/form-data</code></li>
<li><code>application/x-www-form-urlencoded</code></li>
</ul>
<p>如果以上三个条件同时满足，浏览器判定为简单请求。</p>
<p>下面是一些例子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 简单请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/news"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 请求方法不满足要求，不是简单请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/news"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  method<span class="token operator">:</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加入了额外的请求头，不是简单请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/news"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  headers<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 简单请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/news"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  method<span class="token operator">:</span> <span class="token string">"post"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// content-type不满足要求，不是简单请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/news"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  method<span class="token operator">:</span> <span class="token string">"post"</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="简单请求的交互规范"><a href="#简单请求的交互规范" class="headerlink" title="简单请求的交互规范"></a>简单请求的交互规范</h2><p>当浏览器判定某个<strong>ajax 跨域请求</strong>是<strong>简单请求</strong>时，会发生以下的事情</p>
<ol>
<li><strong>请求头中会自动添加</strong><code>**Origin**</code><strong>字段</strong></li>
</ol>
<p>比如，在页面<code>http://my.com/index.html</code>中有以下代码造成了跨域</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 简单请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/news"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>请求发出后，请求头会是下面的格式：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;api&#x2F;news&#x2F; HTTP&#x2F;1.1
Host: crossdomain.com
Connection: keep-alive
...
Referer: http:&#x2F;&#x2F;my.com&#x2F;index.html
Origin: http:&#x2F;&#x2F;my.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看到最后一行没，<code>Origin</code>字段会告诉服务器，是哪个源地址在跨域请求</p>
<ol start="2">
<li><strong>服务器响应头中应包含</strong><code>**Access-Control-Allow-Origin**</code></li>
</ol>
<p>当服务器收到请求后，如果允许该请求跨域访问，需要在响应头中添加<code>Access-Control-Allow-Origin</code>字段</p>
<p>该字段的值可以是：</p>
<ul>
<li>*：表示我很开放，什么人我都允许访问</li>
<li>具体的源：比如<code>http://my.com</code>，表示我就允许你访问</li>
</ul>
<blockquote>
<p>实际上，这两个值对于客户端<code>http://my.com</code>而言，都一样，因为客户端才不会管其他源服务器允不允许，就关心自己是否被允许</p>
<p>当然，服务器也可以维护一个可被允许的源列表，如果请求的<code>Origin</code>命中该列表，才响应<code>*</code>或具体的源</p>
<p><strong>为了避免后续的麻烦，强烈推荐响应具体的源</strong></p>
</blockquote>
<p>假设服务器做出了以下的响应：</p>
<pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
Date: Tue, 21 Apr 2020 08:03:35 GMT
...
Access-Control-Allow-Origin: http:&#x2F;&#x2F;my.com
...

消息体中的数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当浏览器看到服务器允许自己访问后，高兴的像一个两百斤的孩子，于是，它就把响应顺利的交给 js，以完成后续的操作</p>
<p>下图简述了整个交互过程</p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200421162846480.png#id=KpaZX&originHeight=354&originWidth=1000&originalType=binary&ratio=1&status=done&style=none"></p>
<h1 id="需要预检的请求"><a href="#需要预检的请求" class="headerlink" title="需要预检的请求"></a>需要预检的请求</h1><p>简单的请求对服务器的威胁不大，所以允许使用上述的简单交互即可完成。</p>
<p>但是，如果浏览器不认为这是一种简单请求，就会按照下面的流程进行：</p>
<ol>
<li><strong>浏览器发送预检请求，询问服务器是否允许</strong></li>
<li><strong>服务器允许</strong></li>
<li><strong>浏览器发送真实请求</strong></li>
<li><strong>服务器完成真实的响应</strong></li>
</ol>
<p>比如，在页面<code>http://my.com/index.html</code>中有以下代码造成了跨域</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 需要预检的请求</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://crossdomain.com/api/user"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token comment">// post 请求</span>
  headers<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 设置请求头</span>
    a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">"袁小进"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 设置请求体</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>浏览器发现它不是一个简单请求，则会按照下面的流程与服务器交互</p>
<ol>
<li><strong>浏览器发送预检请求，询问服务器是否允许</strong></li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">OPTIONS &#x2F;api&#x2F;user HTTP&#x2F;1.1
Host: crossdomain.com
...
Origin: http:&#x2F;&#x2F;my.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: a, b, content-type<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出，这并非我们想要发出的真实请求，请求中不包含我们的响应头，也没有消息体。</p>
<p>这是一个预检请求，它的目的是询问服务器，是否允许后续的真实请求。</p>
<p>预检请求<strong>没有请求体</strong>，它包含了后续真实请求要做的事情</p>
<p>预检请求有以下特征：</p>
<ul>
<li>请求方法为<code>OPTIONS</code></li>
<li>没有请求体</li>
<li>请求头中包含<ul>
<li><code>Origin</code>：请求的源，和简单请求的含义一致</li>
<li><code>Access-Control-Request-Method</code>：后续的真实请求将使用的请求方法</li>
<li><code>Access-Control-Request-Headers</code>：后续的真实请求会改动的请求头</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>服务器允许</strong></li>
</ol>
<p>服务器收到预检请求后，可以检查预检请求中包含的信息，如果允许这样的请求，需要响应下面的消息格式</p>
<pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
Date: Tue, 21 Apr 2020 08:03:35 GMT
...
Access-Control-Allow-Origin: http:&#x2F;&#x2F;my.com
Access-Control-Allow-Methods: POST
Access-Control-Allow-Headers: a, b, content-type
Access-Control-Max-Age: 86400
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于预检请求，不需要响应任何的消息体，只需要在响应头中添加：</p>
<ul>
<li><code>Access-Control-Allow-Origin</code>：和简单请求一样，表示允许的源</li>
<li><code>Access-Control-Allow-Methods</code>：表示允许的后续真实的请求方法</li>
<li><code>Access-Control-Allow-Headers</code>：表示允许改动的请求头</li>
<li><code>Access-Control-Max-Age</code>：告诉浏览器，多少秒内，对于同样的请求源、方法、头，都不需要再发送预检请求了</li>
</ul>
<ol start="3">
<li><strong>浏览器发送真实请求</strong></li>
</ol>
<p>预检被服务器允许后，浏览器就会发送真实请求了，上面的代码会发生下面的请求数据</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;api&#x2F;user HTTP&#x2F;1.1
Host: crossdomain.com
Connection: keep-alive
...
Referer: http:&#x2F;&#x2F;my.com&#x2F;index.html
Origin: http:&#x2F;&#x2F;my.com

&#123;&quot;name&quot;: &quot;袁小进&quot;, &quot;age&quot;: 18 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li><strong>服务器响应真实请求</strong></li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
Date: Tue, 21 Apr 2020 08:03:35 GMT
...
Access-Control-Allow-Origin: http:&#x2F;&#x2F;my.com
...

添加用户成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出，当完成预检之后，后续的处理与简单请求相同</p>
<p>下图简述了整个交互过程</p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200421165913320.png#id=RNMxb&originHeight=872&originWidth=1134&originalType=binary&ratio=1&status=done&style=none"></p>
<h1 id="附带身份凭证的请求"><a href="#附带身份凭证的请求" class="headerlink" title="附带身份凭证的请求"></a>附带身份凭证的请求</h1><p>默认情况下，ajax 的跨域请求并不会附带 cookie，这样一来，某些需要权限的操作就无法进行</p>
<p>不过可以通过简单的配置就可以实现附带 cookie</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// xhr</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// fetch api</span>
<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  credentials<span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样一来，该跨域的 ajax 请求就是一个<em>附带身份凭证的请求</em></p>
<p>当一个请求需要附带 cookie 时，无论它是简单请求，还是预检请求，都会在请求头中添加<code>cookie</code>字段</p>
<p>而服务器响应时，需要明确告知客户端：服务器允许这样的凭据</p>
<p>告知的方式也非常的简单，只需要在响应头中添加：<code>Access-Control-Allow-Credentials: true</code>即可</p>
<p>对于一个附带身份凭证的请求，若服务器没有明确告知，浏览器仍然视为跨域被拒绝。</p>
<p>另外要特别注意的是：**对于附带身份凭证的请求，服务器不得设置 **<code>**Access-Control-Allow-Origin 的值为***</code>。这就是为什么不推荐使用*的原因</p>
<h1 id="一个额外的补充"><a href="#一个额外的补充" class="headerlink" title="一个额外的补充"></a>一个额外的补充</h1><p>在跨域访问时，JS 只能拿到一些最基本的响应头，如：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果要访问其他头，则需要服务器设置本响应头。</p>
<p><code>Access-Control-Expose-Headers</code>头让服务器把允许浏览器访问的头放入白名单，例如：</p>
<pre class="line-numbers language-none"><code class="language-none">Access-Control-Expose-Headers: authorization, a, b<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样 JS 就能够访问指定的响应头了。<br>​</p>
<h2 id="CORS-中间件"><a href="#CORS-中间件" class="headerlink" title="CORS 中间件"></a>CORS 中间件</h2><p>​</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/expressjs/cors#readme">https://github.com/expressjs/cors#readme</a></p>
</blockquote>
<h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/expressjs/session">https://github.com/expressjs/session</a></p>
</blockquote>
<pre><code>    cookie
        存储在客户端
        优点
            存储在客户端，不占用服务器资源
        缺点
            只能是字符串格式
            存储量有限
                sessionStorage
                localStorage
            数据容易被获取
            数据容易被篡改
            容易丢失
    session
        存储在服务器端
        优点
            可以是任何格式
            存储量理论上是无限的
            数据难以被获取
            数据难以篡改
            不易丢失
        缺点
            占用服务器资源
    uuid
        universal unique identity
</code></pre>
<h2 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h2><p>随着前后端分离的发展，以及数据中心的建立，越来越多的公司会创建一个中心服务器，服务于各种产品线。</p>
<p>而这些产品线上的产品，它们可能有着各种终端设备，包括但不仅限于浏览器、桌面应用、移动端应用、平板应用、甚至智能家居</p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200422163727151.png#id=uTqrt&originHeight=342&originWidth=384&originalType=binary&ratio=1&status=done&style=none"></p>
<blockquote>
<p>实际上，不同的产品线通常有自己的服务器，产品内部的数据一般和自己的服务器交互。</p>
<p>但中心服务器仍然有必要存在，因为同一家公司的产品总是会存在共享的数据，比如用户数据</p>
</blockquote>
<p>这些设备与中心服务器之间会进行 http 通信</p>
<p>一般来说，中心服务器至少承担着认证和授权的功能，例如登录：各种设备发送消息到中心服务器，然后中心服务器响应一个身份令牌（参见<a target="_blank" rel="noopener" href="http://www.yuanjin.tech/article/98">cookie 原理详解</a>）</p>
<p>当这种结构出现后，就出现一个问题：它们之间还能使用传统的 cookie 方式传递令牌信息吗？</p>
<p>其实，也是可以的 🐶，因为 cookie 在传输中无非是一个消息头而已，只不过浏览器对这个消息头有特殊处理罢了。</p>
<p>但浏览器之外的设备肯定不喜欢 cookie，因为浏览器有着对 cookie 完善的管理机制，但是在其他设备上，就需要开发者自己手动处理了</p>
<p>jwt 的出现就是为了解决这个问题</p>
<h1 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h1><p>jwt 全称<code>Json Web Token</code>，强行翻译过来就是<code>json格式的互联网令牌</code>（算了，还是不要强行翻译了 🐷）</p>
<p>它要解决的问题，就是为多种终端设备，提供<strong>统一的、安全的</strong>令牌格式</p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200422165350268.png#id=F8BRo&originHeight=344&originWidth=392&originalType=binary&ratio=1&status=done&style=none"></p>
<p>因此，jwt 只是一个令牌格式而已，你可以把它存储到 cookie，也可以存储到 localstorage，没有任何限制！</p>
<p>同样的，对于传输，你可以使用任何传输方式来传输 jwt，一般来说，我们会使用消息头来传输它</p>
<p>比如，当登录成功后，服务器可以给客户端响应一个 jwt：</p>
<pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
...
set-cookie:token&#x3D;jwt令牌
authorization:jwt令牌
...

&#123;..., token:jwt令牌&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，jwt 令牌可以出现在响应的任何一个地方，客户端和服务器自行约定即可。</p>
<blockquote>
<p>当然，它也可以出现在响应的多个地方，比如为了充分利用浏览器的 cookie，同时为了照顾其他设备，也可以让 jwt 出现在<code>set-cookie</code>和<code>authorization或body</code>中，尽管这会增加额外的传输量。</p>
</blockquote>
<p>当客户端拿到令牌后，它要做的只有一件事：存储它。</p>
<p>你可以存储到任何位置，比如手机文件、PC 文件、localstorage、cookie</p>
<p>当后续请求发生时，你只需要将它作为请求的一部分发送到服务器即可。</p>
<p>虽然 jwt 没有明确要求应该如何附带到请求中，但通常我们会使用如下的格式：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;api&#x2F;resources HTTP&#x2F;1.1
...
authorization: bearer jwt令牌
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>这种格式是 OAuth2 附带 token 的一种规范格式</p>
<p>至于什么是 OAuth2，那是另一个话题了</p>
</blockquote>
<p>这样一来，服务器就能够收到这个令牌了，通过对令牌的验证，即可知道该令牌是否有效。</p>
<p>它们的完整交互流程是非常简单清晰的</p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200422172837190.png#id=TuO9O&originHeight=386&originWidth=394&originalType=binary&ratio=1&status=done&style=none"></p>
<h1 id="令牌的组成"><a href="#令牌的组成" class="headerlink" title="令牌的组成"></a>令牌的组成</h1><p>为了保证令牌的安全性，jwt 令牌由三个部分组成，分别是：</p>
<ol>
<li>header：令牌头部，记录了整个令牌的类型和签名算法</li>
<li>payload：令牌负荷，记录了保存的主体信息，比如你要保存的用户信息就可以放到这里</li>
<li>signature：令牌签名，按照头部固定的签名算法对整个令牌进行签名，该签名的作用是：保证令牌不被伪造和篡改</li>
</ol>
<p>它们组合而成的完整格式是：<code>header.payload.signature</code></p>
<p>比如，一个完整的 jwt 令牌如下：</p>
<pre class="line-numbers language-none"><code class="language-none">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9.BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>它各个部分的值分别是：</p>
<ul>
<li><code>header：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</code></li>
<li><code>payload：eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9</code></li>
<li><code>signature: BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc</code></li>
</ul>
<p>下面分别对每个部分进行说明</p>
<h2 id="header"><a href="#header" class="headerlink" title="header"></a>header</h2><p>它是令牌头部，记录了整个令牌的类型和签名算法</p>
<p>它的格式是一个<code>json</code>对象，如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span><span class="token punctuation">,</span>
  <span class="token property">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>该对象记录了：</p>
<ul>
<li>alg：signature 部分使用的签名算法，通常可以取两个值<ul>
<li>HS256：一种对称加密算法，使用同一个秘钥对 signature 加密解密</li>
<li>RS256：一种非对称加密算法，使用私钥加密，公钥解密</li>
</ul>
</li>
<li>typ：整个令牌的类型，固定写<code>JWT</code>即可</li>
</ul>
<p>设置好了<code>header</code>之后，就可以生成<code>header</code>部分了</p>
<p>具体的生成方式及其简单，就是把<code>header</code>部分使用<code>base64 url</code>编码即可</p>
<blockquote>
<p><code>base64 url</code>不是一个加密算法，而是一种编码方式，它是在<code>base64</code>算法的基础上对<code>+</code>、<code>=</code>、<code>/</code>三个字符做出特殊处理的算法</p>
<p>而<code>base64</code>是使用 64 个可打印字符来表示一个二进制数据，具体的做法参考<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/base64/8545775?fr=aladdin">百度百科</a></p>
</blockquote>
<p>浏览器提供了<code>btoa</code>函数，可以完成这个操作：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">window<span class="token punctuation">.</span><span class="token function">btoa</span><span class="token punctuation">(</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    alg<span class="token operator">:</span> <span class="token string">"HS256"</span><span class="token punctuation">,</span>
    typ<span class="token operator">:</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 得到字符串：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同样的，浏览器也提供了<code>atob</code>函数，可以对其进行解码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">window<span class="token punctuation">.</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 得到字符串：&#123;"alg":"HS256","typ":"JWT"&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>nodejs 中没有提供这两个函数，可以安装第三方库<code>atob</code>和<code>bota</code>搞定</p>
<p>或者，手动搞定</p>
</blockquote>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>这部分是 jwt 的主体信息，它仍然是一个 JSON 对象，它可以包含以下内容：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token string">"ss"</span>：<span class="token string">"发行者"</span><span class="token punctuation">,</span>
	<span class="token string">"iat"</span>：<span class="token string">"发布时间"</span><span class="token punctuation">,</span>
	<span class="token string">"exp"</span>：<span class="token string">"到期时间"</span><span class="token punctuation">,</span>
	<span class="token string">"sub"</span>：<span class="token string">"主题"</span><span class="token punctuation">,</span>
	<span class="token string">"aud"</span>：<span class="token string">"听众"</span><span class="token punctuation">,</span>
	<span class="token string">"nbf"</span>：<span class="token string">"在此之前不可用"</span><span class="token punctuation">,</span>
  <span class="token string">"jti"</span>：<span class="token string">"JWT ID"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上属性可以全写，也可以一个都不写，它只是一个规范，就算写了，也需要你在将来验证这个 jwt 令牌时手动处理才能发挥作用</p>
<p>上述属性表达的含义分别是：</p>
<ul>
<li>ss：发行该 jwt 的是谁，可以写公司名字，也可以写服务名称</li>
<li>iat：该 jwt 的发放时间，通常写当前时间的时间戳</li>
<li>exp：该 jwt 的到期时间，通常写时间戳</li>
<li>sub：该 jwt 是用于干嘛的</li>
<li>aud：该 jwt 是发放给哪个终端的，可以是终端类型，也可以是用户名称，随意一点</li>
<li>nbf：一个时间点，在该时间点到达之前，这个令牌是不可用的</li>
<li>jti：jwt 的唯一编号，设置此项的目的，主要是为了防止重放攻击（重放攻击是在某些场景下，用户使用之前的令牌发送到服务器，被服务器正确的识别，从而导致不可预期的行为发生）</li>
</ul>
<p>可是到现在，看了半天，没有出现我想要写入的数据啊 😂</p>
<p>当用户登陆成功之后，我可能需要把用户的一些信息写入到 jwt 令牌中，比如用户 id、账号等等（密码就算了 😳）</p>
<p>其实很简单，payload 这一部分只是一个 json 对象而已，你可以向对象中加入任何想要加入的信息</p>
<p>比如，下面的 json 对象仍然是一个有效的 payload</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"foo"</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1587548215</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>foo: bar</code>是我们自定义的信息，<code>iat: 1587548215</code>是 jwt 规范中的信息</p>
<p>最终，payload 部分和 header 一样，需要通过<code>base64 url</code>编码得到：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">window<span class="token punctuation">.</span><span class="token function">btoa</span><span class="token punctuation">(</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    foo<span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span>
    iat<span class="token operator">:</span> <span class="token number">1587548215</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 得到字符串：eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="signature"><a href="#signature" class="headerlink" title="signature"></a>signature</h2><p>这一部分是 jwt 的签名，正是它的存在，保证了整个 jwt 不被篡改</p>
<p>这部分的生成，是对前面两个部分的编码结果，按照头部指定的方式进行加密</p>
<p>比如：头部指定的加密方法是<code>HS256</code>，前面两部分的编码结果是<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9</code></p>
<p>则第三部分就是用对称加密算法<code>HS256</code>对字符串<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9</code>进行加密，当然你得指定一个秘钥，比如<code>shhhhh</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">HS256</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token string">"shhhhh"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 得到：BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最终，将三部分组合在一起，就得到了完整的 jwt</p>
<pre class="line-numbers language-none"><code class="language-none">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9.BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于签名使用的秘钥保存在服务器，这样一来，客户端就无法伪造出签名，因为它拿不到秘钥。</p>
<p>换句话说，之所以说无法伪造 jwt，就是因为第三部分的存在。</p>
<p>而前面两部分并没有加密，只是一个编码结果而已，可以认为几乎是明文传输</p>
<blockquote>
<p>这不会造成太大的问题，因为既然用户登陆成功了，它当然有权力查看自己的用户信息</p>
<p>甚至在某些网站，用户的基本信息可以被任何人查看</p>
<p>你要保证的，是不要把敏感的信息存放到 jwt 中，比如密码</p>
</blockquote>
<p>jwt 的<code>signature</code>可以保证令牌不被伪造，那如何保证令牌不被篡改呢？</p>
<p>比如，某个用户登陆成功了，获得了 jwt，但他人为的篡改了<code>payload</code>，比如把自己的账户余额修改为原来的两倍，然后重新编码出<code>payload</code>发送到服务器，服务器如何得知这些信息被篡改过了呢？</p>
<p>这就要说到令牌的验证了</p>
<h1 id="令牌的验证"><a href="#令牌的验证" class="headerlink" title="令牌的验证"></a>令牌的验证</h1><p><img src="http://mdrs.yuanjin.tech/img/image-20200422172837190.png#id=hZbwq&originHeight=386&originWidth=394&originalType=binary&ratio=1&status=done&style=none"></p>
<p>令牌在服务器组装完成后，会以任意的方式发送到客户端</p>
<p>客户端会把令牌保存起来，后续的请求会将令牌发送给服务器</p>
<p>而服务器需要验证令牌是否正确，如何验证呢？</p>
<p>首先，服务器要验证这个令牌是否被篡改过，验证方式非常简单，就是对<code>header+payload</code>用同样的秘钥和加密算法进行重新加密</p>
<p>然后把加密的结果和传入 jwt 的<code>signature</code>进行对比，如果完全相同，则表示前面两部分没有动过，就是自己颁发的，如果不同，肯定是被篡改过了。</p>
<pre class="line-numbers language-none"><code class="language-none">传入的header.传入的payload.传入的signature
新的signature &#x3D; header中的加密算法(传入的header.传入的payload, 秘钥)
验证：新的signature &#x3D;&#x3D; 传入的signature<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>当令牌验证为没有被篡改后，服务器可以进行其他验证：比如是否过期、听众是否满足要求等等，这些就视情况而定了</p>
<p>注意：这些验证都需要服务器手动完成，没有哪个服务器会给你进行自动验证，当然，你可以借助第三方库来完成这些操作</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>最后，总结一下 jwt 的特点：</p>
<ul>
<li>jwt 本质上是一种令牌格式。它和终端设备无关，同样和服务器无关，甚至与如何传输无关，它只是规范了令牌的格式而已</li>
<li>jwt 由三部分组成：header、payload、signature。主体信息在 payload</li>
<li>jwt 难以被篡改和伪造。这是因为有第三部分的签名存在。</li>
</ul>
<h2 id="登录和认证-服务器开发"><a href="#登录和认证-服务器开发" class="headerlink" title="登录和认证-服务器开发"></a>登录和认证-服务器开发</h2><pre><code>    jsonwebtoken库
</code></pre>
<p>​</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/auth0/node-jsonwebtoken#readme">https://github.com/auth0/node-jsonwebtoken#readme</a></p>
</blockquote>
<pre><code>        express-jwt
    颁发jwt
        确定过期时间
        确定主体
        确定密钥
        确定传输方式
            cookie
            authorization
    认证jwt
        获取jwt
            从cookie中
            从authorization中
                带bearer
                不带bearer
        验证jwt
    添加whoami接口
</code></pre>
<h2 id="登录和认证-客户端开发"><a href="#登录和认证-客户端开发" class="headerlink" title="登录和认证-客户端开发"></a>登录和认证-客户端开发</h2><pre><code>    history api fallback
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/connect-history-api-fallback">https://www.npmjs.com/package/connect-history-api-fallback</a></p>
</blockquote>
<h2 id="场景-日志记录"><a href="#场景-日志记录" class="headerlink" title="场景 - 日志记录"></a>场景 - 日志记录</h2><h2 id="场景-文件上传"><a href="#场景-文件上传" class="headerlink" title="场景 - 文件上传"></a>场景 - 文件上传</h2><pre><code>    文件上传使用的http报文格式
    服务器解析处理请求体
        multer
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/expressjs/multer#readme">https://github.com/expressjs/multer#readme</a></p>
</blockquote>
<h2 id="场景-文件下载"><a href="#场景-文件下载" class="headerlink" title="场景 - 文件下载"></a>场景 - 文件下载</h2><h2 id="场景-图片水印"><a href="#场景-图片水印" class="headerlink" title="场景 - 图片水印"></a>场景 - 图片水印</h2><pre><code>    Jimp
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/oliver-moran/jimp">https://github.com/oliver-moran/jimp</a></p>
</blockquote>
<h2 id="场景-图片防盗链"><a href="#场景-图片防盗链" class="headerlink" title="场景 - 图片防盗链"></a>场景 - 图片防盗链</h2><h2 id="重要场景-代理"><a href="#重要场景-代理" class="headerlink" title="重要场景 - 代理"></a>重要场景 - 代理</h2><pre><code>    原理图，见课件
    http-proxy-middleware
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/chimurai/http-proxy-middleware">https://github.com/chimurai/http-proxy-middleware</a></p>
</blockquote>
<h2 id="扩展场景-模板引擎"><a href="#扩展场景-模板引擎" class="headerlink" title="扩展场景 - 模板引擎"></a>扩展场景 - 模板引擎</h2><pre><code>    概念
        见源码中的图片
    模板引擎
        在静态内容中插入动态内容
        常见模板引擎
            mustache
            ejs
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/mde/ejs">https://github.com/mde/ejs</a></p>
</blockquote>
<h2 id="场景-生成二维码"><a href="#场景-生成二维码" class="headerlink" title="场景 - 生成二维码"></a>场景 - 生成二维码</h2><pre><code>    二维码的概念

        矩阵点
            通常是白色或黑色的小点
            深色表示1
            白色表示0
        位置探测组
            三个位于角落的嵌套矩形
            用于定位二维码图片的方向
        Version
            1~40的数字
            数字越大，表示整个二维码的矩阵越大
                1是21*21
                40是177*177
        mode
            字符编码方式
                Numeric
                Alphanumeric
                Kanji
                Byte
        纠错等级
            L
            M
            Q
            H
            纠错等级越高，能够表达的字符量越少
    生成二维码
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/soldair/node-qrcode">https://github.com/soldair/node-qrcode</a></p>
</blockquote>
<h2 id="场景-生成验证码"><a href="#场景-生成验证码" class="headerlink" title="场景 - 生成验证码"></a>场景 - 生成验证码</h2><pre><code>    验证码作用
        防止机器提交
    验证码类型
        普通验证码
        行为验证码
    流程
        获取验证码图片
            客户端通过img元素的src地址获取验证码图片
            服务器生成随机图片[https://github.com/produck/svg-captcha/blob/1.x/README_CN.md](https://github.com/produck/svg-captcha/blob/1.x/README_CN.md)
            服务器保存随机图片中的文字
        验证
            服务器判断是否对验证码进行验证
            验证客户端传递的验证码是否和服务器保存的一致
</code></pre>
<h2 id="场景-客户端缓存"><a href="#场景-客户端缓存" class="headerlink" title="场景 - 客户端缓存"></a>场景 - 客户端缓存</h2><pre><code>    缓存原理：见课件
</code></pre>
<h2 id="场景-富文本框"><a href="#场景-富文本框" class="headerlink" title="场景 - 富文本框"></a>场景 - 富文本框</h2><pre><code>    富文本框的本质
        一个可以被编辑的div
        编辑后得到的结果是一个html字符串
    wangEditor[https://www.wangeditor.com/](https://www.wangeditor.com/)
</code></pre>
<p>​</p>
<h1 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h1><ol>
<li>客户端连接服务器（TCP / IP），三次握手，建立了连接通道</li>
<li>客户端和服务器通过 socket 接口发送消息和接收消息，任何一端在任何时候，都可以向另一端发送任何消息</li>
<li>有一端断开了，通道销毁</li>
</ol>
<h1 id="http"><a href="#http" class="headerlink" title="http"></a>http</h1><ol>
<li>客户端连接服务器（TCP / IP），三次握手，建立了连接通道</li>
<li>客户端发送一个 http 格式的消息（消息头 消息体），服务器响应 http 格式的消息（消息头 消息体）</li>
<li>客户端或服务器断开，通道销毁</li>
</ol>
<p>实时性的问题：</p>
<ol>
<li>轮询</li>
<li>长连接</li>
</ol>
<h1 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h1><p>专门用于解决<strong>实时传输的问题</strong></p>
<ol>
<li>客户端连接服务器（TCP / IP），三次握手，建立了连接通道</li>
<li>客户端发送一个 http 格式的消息（特殊格式），服务器也响应一个 http 格式的消息（特殊格式），称之为<strong>http 握手</strong></li>
<li><strong>双发自由通信，</strong>通信格式<strong>按照 websocket 的要求</strong>进行</li>
<li>客户端或服务器断开，通道销毁</li>
</ol>
<h1 id="服务端握手响应"><a href="#服务端握手响应" class="headerlink" title="服务端握手响应"></a>服务端握手响应</h1><p>在 websocket 的 http 握手阶段，服务器响应头中需要包含如下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: [key]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>其中，<code>Sec-WebSocket-Accept</code>的值来自于以下算法：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">base64</span><span class="token punctuation">(</span><span class="token function">sha1</span><span class="token punctuation">(</span>Sec <span class="token operator">-</span> WebSocket <span class="token operator">-</span> Key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在<code>node</code>中可以使用以下代码获得：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>requestKey <span class="token operator">+</span> <span class="token string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，<code>requestKey</code>来自于请求头中的<code>Sec-WebSocket-Key</code><br>​</p>
<p><a target="_blank" rel="noopener" href="https://socket.io/">https://socket.io/</a><br>​</p>
<h1 id="在线聊天室"><a href="#在线聊天室" class="headerlink" title="在线聊天室"></a>在线聊天室</h1><h1 id="客户端发送"><a href="#客户端发送" class="headerlink" title="客户端发送"></a>客户端发送</h1><h2 id="获取当前所有在线用户"><a href="#获取当前所有在线用户" class="headerlink" title="获取当前所有在线用户"></a>获取当前所有在线用户</h2><p>消息名称：users</p>
<p>消息内容：无</p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>消息名称：login</p>
<p>消息内容：用户名</p>
<h2 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h2><p>消息名称：msg</p>
<p>消息内容：<code>&#123;to:&quot;目标用户名，null表示所有人&quot;, content:&quot;消息内容&quot;&#125;</code></p>
<h1 id="服务器发送"><a href="#服务器发送" class="headerlink" title="服务器发送"></a>服务器发送</h1><h2 id="获取当前所有在线用户-1"><a href="#获取当前所有在线用户-1" class="headerlink" title="获取当前所有在线用户"></a>获取当前所有在线用户</h2><p>消息名称：users</p>
<p>消息内容：用户数组</p>
<h2 id="登录-1"><a href="#登录-1" class="headerlink" title="登录"></a>登录</h2><p>消息名称：login</p>
<p>消息内容：true 或 false，true 表示登录成功，false 表示登录失败（昵称已存在）</p>
<h2 id="新用户进入"><a href="#新用户进入" class="headerlink" title="新用户进入"></a>新用户进入</h2><p>消息名称：userin</p>
<p>消息内容：用户名</p>
<h2 id="用户离开"><a href="#用户离开" class="headerlink" title="用户离开"></a>用户离开</h2><p>消息名称：userout</p>
<p>消息内容：用户名</p>
<h2 id="新消息来了"><a href="#新消息来了" class="headerlink" title="新消息来了"></a>新消息来了</h2><p>消息名称：new msg</p>
<p>消息内容：<code>&#123;from:&quot;用户名&quot;, content:&quot;消息内容&quot;, to:&quot;接收消息的人，如果是null，表示所有人&quot;&#125;</code><br>​</p>
<p>​</p>
<h1 id="CSRF-攻击与防御"><a href="#CSRF-攻击与防御" class="headerlink" title="CSRF 攻击与防御"></a>CSRF 攻击与防御</h1><h1 id="CSRF-特点和原理"><a href="#CSRF-特点和原理" class="headerlink" title="CSRF 特点和原理"></a>CSRF 特点和原理</h1><p>CSRF：Cross Site Request Forgery，<strong>跨站请求伪造</strong></p>
<p>本质是：恶意网站把<strong>正常用户</strong>作为<strong>媒介</strong>，通过模拟正常用户的操作，攻击其<strong>登录过</strong>的站点。</p>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200508122744169.png#id=cEyKS&originHeight=576&originWidth=1124&originalType=binary&ratio=1&status=done&style=none"></p>
<p>它的原理如下：</p>
<ol>
<li>用户访问正常站点，登录后，获取到了正常站点的令牌，以 cookie 的形式保存</li>
</ol>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200508123116104.png#id=EXZoo&originHeight=366&originWidth=1418&originalType=binary&ratio=1&status=done&style=none"></p>
<ol start="2">
<li>用户访问恶意站点，恶意站点通过某种形式去请求了正常站点（请求伪造），迫使正常用户把令牌传递到正常站点，完成攻击</li>
</ol>
<p><img src="http://mdrs.yuanjin.tech/img/image-20200508123401591.png#id=pgMFQ&originHeight=624&originWidth=1406&originalType=binary&ratio=1&status=done&style=none"></p>
<h1 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h1><h2 id="cookie-的-SameSite"><a href="#cookie-的-SameSite" class="headerlink" title="cookie 的 SameSite"></a>cookie 的 SameSite</h2><p>现在很多浏览器都支持<strong>禁止跨域附带的 cookie</strong>，只需要把 cookie 设置的<code>SameSite</code>设置为<code>Strict</code>即可</p>
<p><code>SameSite</code>有以下取值：</p>
<ul>
<li>Strict：严格，<strong>所有跨站请求都不附带 cookie</strong>，有时会导致用户体验不好</li>
<li>Lax：宽松，所有跨站的超链接、GET 请求的表单、预加载连接时会发送 cookie，其他情况不发送</li>
<li>None：无限制</li>
</ul>
<p>这种方法非常简单，极其有效，但前提条件是：用户不能使用太旧的浏览器</p>
<h2 id="验证-referer-和-Origin"><a href="#验证-referer-和-Origin" class="headerlink" title="验证 referer 和 Origin"></a>验证 referer 和 Origin</h2><p>页面中的二次请求都会附带 referer 或 Origin 请求头，向服务器表示该请求来自于哪个源或页面，服务器可以通过这个头进行验证</p>
<p>但某些浏览器的 referer 是可以被用户禁止的，尽管这种情况极少</p>
<h2 id="使用非-cookie-令牌"><a href="#使用非-cookie-令牌" class="headerlink" title="使用非 cookie 令牌"></a>使用非 cookie 令牌</h2><p>这种做法是要求每次请求需要在请求体或请求头中附带 token</p>
<p>请求的时候：authorization: token</p>
<h2 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h2><p>这种做法是要求每个要防止 CSRF 的请求都必须要附带验证码</p>
<p>不好的地方是容易把正常的用户逼疯</p>
<h2 id="表单随机数"><a href="#表单随机数" class="headerlink" title="表单随机数"></a>表单随机数</h2><p>这种做法是服务端渲染时，生成一个随机数，客户端提交时要提交这个随机数，然后服务器端进行对比</p>
<p>该随机数是一次性的</p>
<p>流程：</p>
<ol>
<li>客户端请求服务器，请求添加学生的页面，传递 cookie</li>
<li>服务器<ol>
<li>生成一个随机数，放到 session 中</li>
<li>生成页面时，表单中加入一个隐藏的表单域<code>&lt;input type=&quot;hidden&quot; name=&quot;hash&quot; value=&quot;&lt;%=session[&#39;key&#39;] %&gt;&quot;&gt;</code></li>
</ol>
</li>
<li>填写好信息后，提交表单，会自动提交隐藏的随机数</li>
<li>服务器<ol>
<li>先拿到 cookie，判断是否登录过</li>
<li>对比提交过来的随机数和之前的随机数是否一致</li>
<li>清除掉 session 中的随机数</li>
</ol>
</li>
</ol>
<h2 id="二次验证"><a href="#二次验证" class="headerlink" title="二次验证"></a>二次验证</h2><p>当做出敏感操作时，进行二次验证<br>​</p>
<h1 id="XSS-攻击与防御"><a href="#XSS-攻击与防御" class="headerlink" title="XSS 攻击与防御"></a>XSS 攻击与防御</h1><h1 id="XSS-攻击和防御"><a href="#XSS-攻击和防御" class="headerlink" title="XSS 攻击和防御"></a>XSS 攻击和防御</h1><p>XSS：Cross Site Scripting <strong>跨站脚本攻击</strong></p>
<h2 id="存储型-XSS"><a href="#存储型-XSS" class="headerlink" title="存储型 XSS"></a>存储型 XSS</h2><ol>
<li> 恶意用户提交了恶意内容到服务器</li>
<li> 服务器没有识别，保存了恶意内容到数据库</li>
<li> 正常用户访问服务器</li>
<li> 服务器在不知情的情况下，给予了之前的恶意内容，让正常用户遭到攻击</li>
</ol>
<p>解决：可以使用<strong>库 xss</strong>进行安全性过滤。只会处理 script<br>​</p>
<p>​</p>
<h2 id="反射型"><a href="#反射型" class="headerlink" title="反射型"></a>反射型</h2><ol>
<li>恶意用户分享了一个正常网站的链接，链接中带有恶意内容</li>
<li>正常用户点击了该链接</li>
<li>服务器在不知情的情况，把链接的恶意内容读取了出来，放进了页面中，让正常用户遭到攻击</li>
</ol>
<h2 id="DOM-型"><a href="#DOM-型" class="headerlink" title="DOM 型"></a>DOM 型</h2><ol>
<li>恶意用户通过任何方式，向服务器中注入了一些 dom 元素，从而影响了服务器的 dom 结构</li>
<li>普通用户访问时，运行的是服务器的正常 js 代码</li>
<li>解决：模板引擎编码<code>&lt;a href=&quot;&lt;%=redirect%&gt;&quot;&gt;跳转到：&lt;%=redirect%&gt;&lt;/a&gt;</code>。不要去掉=</li>
</ol>
<p>​</p>
<h1 id="NodeJS-组成原理"><a href="#NodeJS-组成原理" class="headerlink" title="NodeJS 组成原理"></a>NodeJS 组成原理</h1><p><img src="http://mdrs.yuanjin.tech/img/node%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%E5%9B%BE.jpg#height=471&id=CYoEx&originHeight=1342&originWidth=1522&originalType=binary&ratio=1&status=done&style=none&width=534"></p>
<ol>
<li>用户代码</li>
</ol>
<p>JS 代码，开发者编写的</p>
<ol start="2">
<li>第三方库</li>
</ol>
<p>大部分仍然是 JS 代码，由其他开发者编写</p>
<ol start="3">
<li>本地模块代码</li>
</ol>
<p>JS 代码</p>
<ol start="4">
<li>V8 引擎</li>
</ol>
<p>c/c++代码，作用：把 JS 代码解释成为机器码</p>
<p>可以通过<strong>v8 引擎的某种机制，扩展其功能</strong></p>
<p>V8 引擎的扩展和对扩展的编译，是通过一个工具：gyp 工具</p>
<p>某些第三方库需要使用<code>node-gyp</code>工具进行构建，因此需要先安装<code>node-gyp</code><br>​</p>
<p>​</p>
<p>​</p>
<h1 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h1><h1 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h1><p>一个应用程序，总是通过操作系统启动的，当操作系统启动一个应用程序时，会给其分配一个进程</p>
<p>一个进程拥有<strong>独立的、可伸缩的</strong>内存空间，原则上不受其他进程干扰</p>
<p>进程之间是可以通信的，只要两个进程双方遵守一定的协议，比如 ipc</p>
<p><strong>CPU 在不同的进程之间切换执行</strong></p>
<p>虽然一个应用程序在启动时只有一个进程，但它在运行的过程中，可以开启新的进程，进程之间仍然保持相对独立</p>
<p>如果一个进程是直接由操作系统开启，则它叫做主进程</p>
<p>如果一个进程 B 是由进程 A 开启，则 A 是 B 的父进程，B 是 A 的子进程，子进程会继承父进程的一些信息，但仍然保持相对独立</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// nodejs 中开启子进程</span>
<span class="token keyword">const</span> childProcess <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 导入内置模块</span>

childProcess<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>在子进程运行的命令<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> out<span class="token punctuation">,</span> stdErr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 回调函数中可以获取子进程的标准输出，这种数据交互是通过IPC完成的，nodejs已经帮你完成了处理</span>
  <span class="token comment">// err：开启进程过程中发生的错误</span>
  <span class="token comment">// out: 子进程输出的正常内容</span>
  <span class="token comment">// stdErr: 子进程输出的错误内容</span>
  <span class="token comment">// 子进程发生任何的错误，绝不会影响到父进程，它们的内存空间是完全隔离的</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 过去，nodejs没有提供给用户创建线程的接口，只能使用进程的方式</span>
<span class="token comment">// 过去，nodejs还提供了cluster模块，通过另一种模式来创建进程</span>
<span class="token comment">// 现在，nodejs已经提供了线程模块，对进程的操作已经很少使用了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><p>操作系统启动一个进程（无论是主进程，还是子进程），都会自动为它分配一个线程，称之为主线程</p>
<p><strong>程序一定在线程上运行！！</strong></p>
<p>主线程在运行的过程中，可以创建多个线程，这些线程称之为子线程</p>
<p>当操作系统命令 CPU 去执行一个进程时，实际上，是在该进程的多个线程中切换执行</p>
<p>线程和进程很相似，它们都是独立运行，最大的区别在于：<strong>线程的内存空间没有隔离</strong>，共享进程的内存空间，线程之间的数据不用遵守任何协议，可以随意使用</p>
<p>什么时候要使用线程？</p>
<p>使用线程的主要目的，是为了充分使用多核 cpu。线程执行过程中，尽量的不要阻塞。</p>
<p>最理想的线程效果：</p>
<ol>
<li>线程数等于 cpu 的核数</li>
<li>线程永不阻塞<ol>
<li>没有 io</li>
<li>只存在大量运算</li>
</ol>
</li>
<li>线程相对独立，几乎不使用共享数据</li>
</ol>
<p>线程一般处理 cpu 密集型操作（运算操作），而 io 密集型操作不适合使用线程，而适合使用异步</p>
<p>为了避免线程执行过程中共享数据产生的麻烦，nodejs 使用独特的线程机制来尽力规避：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建子线程的父线程</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> Worker <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"worker_threads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>线程执行的入口文件<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  workerData<span class="token operator">:</span> 开启线程时向其传递的数据<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// worker是子线程实例</span>

<span class="token comment">// 通过EventEmitter监听子线程的事件</span>
worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 当子线程退出时运行的事件</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 收到子线程发送的消息时运行的事件</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>任意消息<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 父线程向子线程发送任意消息</span>
worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 退出子线程</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>
  isMainThread<span class="token punctuation">,</span> <span class="token comment">// 是否是主线程</span>
  parentPort<span class="token punctuation">,</span> <span class="token comment">// 用于与父线程通信的端口</span>
  workerData<span class="token punctuation">,</span> <span class="token comment">// 获取线程启动时传递的数据</span>
  threadId<span class="token punctuation">,</span> <span class="token comment">// 获取线程的唯一编号</span>
<span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"worker_threads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

parentPort<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 当收到父线程发送的消息时，触发的事件</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>workerData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向父线程发送消息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Sunny</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2021/07/26/NodeJS/">http://example.com/2021/07/26/NodeJS/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Sunny</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Front-end-article/">
                                    <span class="chip bg-color">Front end article</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/08/03/React-SSR/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="React SSR">
                        
                        <span class="card-title">React SSR</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Sunny
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Front-end-article/">
                        <span class="chip bg-color">Front end article</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/16/TypeScript/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="TypeScript">
                        
                        <span class="card-title">TypeScript</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Sunny
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Front-end-article/">
                        <span class="chip bg-color">Front end article</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <a href="/about" target="_blank">Sunny</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Sunny-117" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:zhiqiangfu6@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1669248141" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1669248141" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
